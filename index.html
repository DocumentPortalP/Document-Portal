<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Documentation Portal</title>
<style>
  :root{ --bg:#f7fafc; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --brand:#2563eb; --line:#e2e8f0; --zebra:#f8fafc; --hover:#eef2ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(4px)}
  .hwrap{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .title{font-weight:800;letter-spacing:.2px}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .stack{display:flex;flex-direction:column;gap:10px}
  .tile{display:block;background:linear-gradient(135deg,#fff,#f8fafc);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px 16px;text-decoration:none;color:inherit}
  .tile h2{margin:0 0 4px 0;font-size:1.1rem}
  .tile p{margin:0;color:var(--muted);font-size:.9rem}
  .tile:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .square{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
  .c1{background:#fef3c7}.c2{background:#dbeafe}.c3{background:#d1fae5}.c4{background:#f3e8ff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px}
  .crumbs a{color:var(--brand);text-decoration:none}
  .crumbs .sep{opacity:.45;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid #cbd5e1}
  .btn.badge{font-size:.9rem;padding:6px 10px}
  .small{font-size:.86rem;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;align-items:center;gap:12px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .item a.title{flex:1;text-decoration:none;color:inherit}
  .item a.title:hover{text-decoration:underline}
  .item .meta{font-size:.82rem;color:var(--muted);margin-top:4px}
  .icon-btn{min-width:34px;min-height:34px;border-radius:999px;border:1px solid #cbd5e1;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-btn svg{width:16px;height:16px;display:block}

  /* Data table */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:0 0 12px 12px;background:#fff}
  table.data{width:100%;border-collapse:separate;border-spacing:0;font-size:0.96rem}
  .data thead th{position:sticky;top:0;z-index:1;background:#f8fafc;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap;user-select:none;cursor:pointer}
  .data thead th .hint{font-weight:600}
  .data thead th .sort{opacity:.7;margin-left:6px;font-size:.9em}
  .data tbody td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:top}
  .data tbody tr:nth-child(odd){background:var(--zebra)}
  .data tbody tr:hover{background:var(--hover)}
  .data .cell-mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.9em;color:#334155}
  .data td, .data th { overflow-wrap:anywhere; word-break:break-word; }
  .data td.wide, .data th.wide { min-width:420px; }
  .data td.asset, .data th.asset { min-width:260px; white-space:nowrap; }

  .scroll-x-top{
    overflow-x:auto; overflow-y:hidden;
    height:14px; background:#fff;
    border:1px solid var(--line);
    border-bottom:0;
    border-radius:12px 12px 0 0;
  }
  .scroll-x-top::-webkit-scrollbar{height:12px}
  .scroll-x-top::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
  .scroll-x-top::-webkit-scrollbar-track{background:#f8fafc;border-radius:8px}

  footer{height:1px}
</style>
</head>
<body>
  <header>
    <div class="hwrap">
      <div class="title">Documentation Portal</div>

      <form id="globalSearchForm" style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="globalSearchInput" type="search" placeholder="Search all files…" aria-label="Search" style="padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;min-width:210px">
        <button class="btn" type="submit">Search</button>
        <button class="btn ghost" id="clearSearchBtn" type="button" style="display:none">Clear</button>
      </form>

      <div id="roleBadge" class="small" style="margin-left:8px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;color:#2563eb;font-weight:700;display:none"></div>
      <button id="logoutBtn" class="btn ghost" style="display:none">Logout</button>
    </div>
  </header>

  <!-- PIN lock -->
  <div id="lockscreen" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f7fafc;z-index:9999;">
    <h2 style="margin-bottom:12px;font-family:Inter,sans-serif;color:#1e293b;">Enter Access Code</h2>
    <input type="password" id="pinInput" placeholder="Code" style="padding:10px 14px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;border-radius:8px;font-size:1rem;">
    <button id="pinBtn" style="margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;">Unlock</button>
    <p id="pinMsg" style="color:#dc2626;margin-top:10px;display:none;">Wrong code</p>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewBackdrop" style="position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;z-index:9998;">
    <div id="previewCard" style="position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);width:min(100vw,1100px);height:min(100vh,88vh);background:#ffffff;border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e2e8f0;background:#f8fafc;padding:8px 12px;">
        <div id="previewTitle" style="font-weight:600;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Preview</div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="previewDownload" class="btn" style="text-decoration:none;padding:6px 10px;border-radius:10px;background:#2563eb;color:#fff">Download</a>
          <button id="previewClose" class="btn ghost" style="padding:6px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b">Close</button>
        </div>
      </div>
      <div id="wm" style="position:absolute;inset:0;pointer-events:none;display:none;align-items:center;justify-content:center;z-index:2">
        <div style="transform:rotate(-25deg);font-weight:800;font-size:48px;color:#0f172a12">CONFIDENTIAL — Documentation Portal</div>
      </div>
      <div id="previewBody" style="width:100%;height:calc(100% - 46px);background:#fff">
        <iframe id="previewFrame" style="width:100%;height:100%;border:0;display:block"></iframe>
        <video id="previewVideo" style="display:none;width:100%;height:100%" controls playsinline></video>
      </div>
    </div>
  </div>

  <main>
    <nav class="crumbs" id="crumbs"></nav>
    <section id="view">
      <div class="stack" id="homeStack"></div>
    </section>
  </main>
  <footer></footer>

  <!-- Google Identity Services + Google API client -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
  /******** CONFIG ********/
  const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
  const API_KEY   = 'YOUR_PUBLIC_API_KEY';
  const SCOPES    = 'https://www.googleapis.com/auth/drive';

  /* ===== Structure ===== */
  const MACHINES = {
    'Bakery 1': ['Mixing','Fermentation','Fritsch','Proover','Oven','Cooler','Freezer'],
    'Bakery 2': ['Mixing','Fermentation','Spiro','Scarifier','Retarder','Rademaker','Proover','Oven','MIB','Freezer','Cooler','AHU'],
    'Bakery 3': ['Site 1 Packing','Site 2 Packing','Paletiser','Retail'],
    'Other'   : ['General'] // 4. sekcija na Home; unutar nje samo Documentation + Procedures
  };

  const FOLDERS = {
    'Bakery 1': {
      'Fritsch':      {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Mixing':       {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Oven':         {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Fermentation': {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Proover':      {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Freezer':      {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'},
      'Cooler':       {documentation:'FOLDER_ID', works:'FOLDER_ID', electrical:'FOLDER_ID', procedures:'FOLDER_ID'}
    },
    'Bakery 2': { /* …popuni svojim ID-ovima… */ },
    'Bakery 3': { /* …popuni svojim ID-ovima… */ },
    'Other': {
      'General': { documentation:'FOLDER_ID_OTHER_DOCS', procedures:'FOLDER_ID_OTHER_PROCS' } // nema works/electrical
    }
  };

  /* Work History → Sheet mapping; ako nema → fallback na Drive listing */
  const WORKS_SHEETS = {
    'Bakery 1': {
      'Fritsch':      {sheetId:'SHEET_ID', sheetName:'Work Histories', gid:'123456'},
      'Mixing':       {sheetId:'SHEET_ID', sheetName:'Work Histories', gid:'123456'},
      // …
    },
    'Bakery 2': {
      // …
    },
    'Bakery 3': {
      // …
    }
  };

  const CATS = {
    documentation: { title:'Documentation',   color:'c1', desc:'User manuals & technical docs' },
    works:         { title:'Work History',    color:'c2', desc:'Repairs, interventions' },
    electrical:    { title:'Electrical Diagrams', color:'c3', desc:'Wiring & schematics' },
    procedures:    { title:'Procedures',      color:'c4', desc:'SOPs & guides' }
  };

  /* ===== Utils ===== */
  function params(){ return new URLSearchParams(location.search); }
  function go(obj){ const u=new URL(location.href); u.search=new URLSearchParams(obj).toString(); history.pushState({},'',u); draw(); }
  window.addEventListener('popstate', draw);
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  function crumbsSet(items){
    const el = document.getElementById('crumbs');
    el.innerHTML='';
    items.forEach((it,i)=>{
      const a=document.createElement('a');
      a.href='javascript:void(0)';
      a.textContent=it.label;
      a.onclick=()=>{ go(it.to||{}); };
      el.appendChild(a);
      if(i<items.length-1){
        const s=document.createElement('span');
        s.className='sep'; s.textContent='›'; el.appendChild(s);
      }
    });
  }

  /* ===== Roles / PIN ===== */
  const ROLE_PINS = { '1111':'operator', '2906':'engineer', '1782':'admin' }; // operator nema Work History
  function getRole(){ return sessionStorage.getItem('role') || 'operator'; }
  function isOperator(){ return getRole()==='operator'; }
  function isEngineer(){ return getRole()==='engineer'; }
  function isAdmin(){ return getRole()==='admin'; }

  const roleBadge = document.getElementById('roleBadge');
  const logoutBtn = document.getElementById('logoutBtn');
  function refreshHeaderAuth(){
    const role = getRole();
    if (sessionStorage.getItem('unlocked')==='1'){
      roleBadge.style.display = '';
      roleBadge.textContent = role.charAt(0).toUpperCase()+role.slice(1);
      logoutBtn.style.display = '';
    } else {
      roleBadge.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  }
  logoutBtn?.addEventListener('click', ()=>{
    sessionStorage.removeItem('unlocked');
    sessionStorage.removeItem('role');
    location.href = location.pathname;
  });

  // Operator allow-list (global, za Documentation & Procedures)
  const OP_ALLOW_KEY = 'operatorAllowList';
  function getOpAllowSet(){ try{ return new Set(JSON.parse(localStorage.getItem(OP_ALLOW_KEY)||'[]')); }catch{ return new Set(); } }
  function setOpAllow(fileId, allow){
    const s = getOpAllowSet(); if(allow) s.add(fileId); else s.delete(fileId);
    localStorage.setItem(OP_ALLOW_KEY, JSON.stringify([...s]));
  }

  /* ===== Google Drive/Auth ===== */
  let accessToken=null,gapiReady=false;
  async function ensureGapi(){
    if(gapiReady) return;
    await new Promise(r=>gapi.load('client',r));
    await gapi.client.init({apiKey:API_KEY,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    gapiReady=true;
  }
  async function ensureAuth(){
    if(!isAdmin()) throw new Error('Only admin can sign in.');
    if(accessToken) return accessToken;
    await ensureGapi();
    return new Promise((res,rej)=>{
      const c=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID, scope:SCOPES,
        callback:r=>{ if(r&&r.access_token){accessToken=r.access_token;res(accessToken);} else rej(new Error('No token')); }
      });
      c.requestAccessToken({prompt:'consent'});
    });
  }
  function isAdminSignedIn(){ return !!accessToken; }
  function publicDownloadUrl(fileId){ return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`; }

  async function fetchPrivateBlob(fileId){
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers:{'Authorization':'Bearer '+accessToken} });
    if(!r.ok) throw new Error('Fetch failed '+r.status);
    return await r.blob();
  }

  /* ===== Preview helpers ===== */
  const previewBackdrop = document.getElementById('previewBackdrop');
  const previewFrame   = document.getElementById('previewFrame');
  const previewVideo   = document.getElementById('previewVideo');
  const previewTitleEl = document.getElementById('previewTitle');
  const previewCloseBtn= document.getElementById('previewClose');
  const previewDownload= document.getElementById('previewDownload');
  const wmEl           = document.getElementById('wm');

  function showPreview(){ previewBackdrop.style.display = 'block'; }
  function hidePreview(){
    previewBackdrop.style.display = 'none';
    try{ if(previewFrame.dataset.blobUrl){ URL.revokeObjectURL(previewFrame.dataset.blobUrl); previewFrame.dataset.blobUrl=''; } }catch{}
    try{ if(previewVideo.dataset.blobUrl){ URL.revokeObjectURL(previewVideo.dataset.blobUrl); previewVideo.dataset.blobUrl=''; } }catch{}
    previewFrame.src = 'about:blank';
    previewVideo.pause(); previewVideo.removeAttribute('src'); previewVideo.style.display='none';
    previewFrame.style.display='block';
  }
  previewBackdrop.addEventListener('click', (e)=>{ if(e.target === previewBackdrop) hidePreview(); });
  previewCloseBtn.addEventListener('click', hidePreview);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && previewBackdrop.style.display==='block') hidePreview(); });

  function isPdf(mime){ return (mime||'').toLowerCase().includes('pdf') || /\.pdf$/i.test(mime||''); }
  function isImage(mime,name){ return (mime||'').startsWith('image/') || /\.(png|jpe?g|gif|bmp|webp|svg)$/i.test(name||''); }
  function isVideo(mime,name){ return (mime||'').startsWith('video/') || /\.(mp4|mov|mkv|webm|avi)$/i.test(mime||''); }

  async function openInlinePreview(f,isAdminMode){
    try{
      previewTitleEl.textContent = f.name || 'Preview';
      previewDownload.href = isAdminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : publicDownloadUrl(f.id);
      const previewUrl = `https://drive.google.com/file/d/${f.id}/preview`;
      const showWm = new URLSearchParams(location.search).get('wm')==='1';
      wmEl.style.display = showWm ? 'flex' : 'none';

      if (isVideo(f.mimeType, f.name)){
        try{
          if(isAdminMode){
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewVideo.dataset.blobUrl = url;
            previewVideo.src = url;
          } else {
            previewVideo.src = publicDownloadUrl(f.id);
          }
          previewFrame.style.display='none';
          previewVideo.style.display='block';
          showPreview(); return;
        }catch(e){ console.warn('Video inline failed, fallback to Drive preview'); }
      }

      if (isPdf(f.mimeType) || isImage(f.mimeType, f.name)){
        if(isAdminMode){
          try{
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewFrame.dataset.blobUrl = url;
            previewFrame.src = url; showPreview(); return;
          }catch(e){ console.warn('Blob preview failed, fallback to Drive preview'); }
        }
        previewFrame.src = previewUrl; showPreview(); return;
      }

      window.open(f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`, '_blank');
    }catch(e){ alert('Preview failed: '+(e.message||String(e))); }
  }

  /* ===== Sheets helpers (GViz JSON → fallback CSV) ===== */
  function parseCsvTable(text){
    const rows = []; let row = [], inQuotes = false, field = '';
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (inQuotes){
        if (ch === '"' && next === '"'){ field += '"'; i++; }
        else if (ch === '"'){ inQuotes = false; }
        else { field += ch; }
      } else {
        if (ch === '"'){ inQuotes = true; }
        else if (ch === ','){ row.push(field); field=''; }
        else if (ch === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
        else if (ch === '\r'){ }
        else { field += ch; }
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    const headers = (rows.shift() || []).map(h => String(h||'').trim());
    return { headers, rows };
  }

  function parseDateSmart(v){
    if (v == null) return NaN;
    if (v instanceof Date) { const t=v.getTime(); return isNaN(t)?NaN:t; }
    if (typeof v === 'string' && /^Date\(\d{4},\d{1,2},\d{1,2}(,\d{1,2},\d{1,2}(,\d{1,2})?)?\)$/.test(v)){
      const nums=v.slice(5,-1).split(',').map(n=>parseInt(n,10));
      const [Y,M,D,h=0,m=0,s=0]=nums; const dt=new Date(Y, M, D, h, m, s); return dt.getTime();
    }
    if (typeof v === 'number' && isFinite(v)){ const ms=(v-25569)*86400*1000; return isNaN(ms)?NaN:ms; }
    const t=String(v).trim(); if(!t) return NaN;
    if(/^\d+(\.\d+)?$/.test(t)){ const n=Number(t); if(isFinite(n)){ const ms=(n-25569)*86400*1000; return isNaN(ms)?NaN:ms; } }
    let d=Date.parse(t); if(!Number.isNaN(d)) return d;
    let m=t.match(/^(\d{1,2})[\/.\-\s](\d{1,2})[\/.\-\s](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ let dd=+m[1], mm=+m[2], yy=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); if(yy<100) yy+=(yy>=70?1900:2000); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    m=t.match(/^(\d{4})[\/.\-\s](\d{1,2})[\/.\-\s](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ const yy=+m[1], mm=+m[2], dd=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    return NaN;
  }
  function formatDateCell(v){
    const ms = parseDateSmart(v); if (isNaN(ms)) return String(v ?? '');
    const d = new Date(ms);
    const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear();
    const hh=d.getHours(); const mi=d.getMinutes(); const ss=d.getSeconds();
    const base=`${dd}.${mm}.${yyyy}`; return (hh+mi+ss)!==0 ? `${base} ${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}` : base;
  }

  async function fetchSheetTable(sheetId, sheetName, gid){
    if (sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('GViz JSON HTTP ' + res.status);
        let text = await res.text();
        text = text.replace(/^\)\]\}'\s*/, '').replace(/^\uFEFF/, '');
        const start = text.indexOf('{'), end = text.lastIndexOf('}');
        if (start === -1 || end === -1 || end <= start) throw new Error('Invalid GViz JSON payload');
        const data = JSON.parse(text.substring(start, end + 1));

        const cols=(data.table.cols||[]);
        const headers = cols.map(c => (c && (c.label || c.id)) || '');
        const types = cols.map(c => (c && c.type) || 'string').map(t => t==='date'||t==='datetime' ? 'date' : (t==='number' ? 'number' : 'text'));
        const rows = (data.table.rows||[]).map(r => (r.c||[]).map(c => {
          if(!c) return '';
          if (c.f != null && c.f !== '') return c.f;
          if (typeof c.v === 'string' && /^Date\(/.test(c.v)) return c.v;
          return (c.v ?? '');
        }));

        const looksLikeLetters = headers.length && headers.every(h => !h || /^[A-Z]+$/.test(String(h)));
        const allEmpty = headers.every(h => !h || String(h).trim()==='');
        let hdrs=headers, rws=rows, tys=types;
        if ((allEmpty || looksLikeLetters) && rows.length){ hdrs = rows[0].map(v => String(v||'').trim()); rws = rows.slice(1); }
        return { headers: hdrs, rows: rws, types: tys };
      } catch (e) {
        try {
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
          const rCsv = await fetch(csvUrl);
          if (!rCsv.ok) throw new Error('GViz CSV HTTP ' + rCsv.status);
          return parseCsvTable(await rCsv.text());
        } catch (e2) {
          if (gid) {
            const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
            const rCsv2 = await fetch(urlCsv);
            if (!rCsv2.ok) throw new Error('CSV export HTTP ' + rCsv2.status);
            return parseCsvTable(await rCsv2.text());
          }
          throw e2;
        }
      }
    }
    if (gid) {
      const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
      const rCsv = await fetch(urlCsv);
      if (!rCsv.ok) throw new Error('CSV export HTTP ' + rCsv.status);
      return parseCsvTable(await rCsv.text());
    }
    throw new Error('No sheetName or gid configured.');
  }

  /* ===== Work History table renderer ===== */
  function renderWorksTable(container, table, sheetId){
    container.innerHTML = '';

    const bar = document.createElement('div'); bar.className='toolbar';
    const search = document.createElement('input'); search.type='search'; search.placeholder='Search…';
    const adminBtns = document.createElement('div'); adminBtns.style.display='flex'; adminBtns.style.gap='8px'; adminBtns.style.marginLeft='auto';
    const dlBtn = document.createElement('button'); dlBtn.className='btn ghost badge'; dlBtn.textContent='Download CSV';
    const openGs = document.createElement('button'); openGs.className='btn ghost badge'; openGs.textContent='Open in Google Sheets (Admin)';
    adminBtns.append(dlBtn, openGs);
    adminBtns.style.display = (isAdmin() && isAdminSignedIn()) ? 'flex' : 'none';
    bar.append(search, adminBtns);
    container.appendChild(bar);

    const topScroll = document.createElement('div');
    topScroll.className = 'scroll-x-top';
    const topInner = document.createElement('div'); topInner.style.height = '1px';
    topScroll.appendChild(topInner); container.appendChild(topScroll);

    const wrap = document.createElement('div'); wrap.className='table-wrap';
    const tableEl = document.createElement('table'); tableEl.className='data';
    wrap.appendChild(tableEl); container.appendChild(wrap);

    const thead = document.createElement('thead'); const trh = document.createElement('tr');

    const wideIdx = new Set(); let assetCol = -1;
    table.headers.forEach((h,i)=>{ if(/job\s*description/i.test(h)) wideIdx.add(i); if(/action\s*taken/i.test(h)) wideIdx.add(i); if (/(^|\b)asset(\b|$)/i.test(h||'')) { assetCol = i; wideIdx.add(i); } });

    table.headers.forEach((h, idx) => {
      const th = document.createElement('th');
      th.innerHTML = `<span class="hint">${escapeHtml(h||`Col ${idx+1}`)}</span><span class="sort">⇅</span>`;
      if (wideIdx.has(idx)) th.classList.add('wide');
      if (idx === assetCol) th.classList.add('asset');
      th.addEventListener('click', () => sortBy(idx));
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tableEl.appendChild(thead);

    const tbody = document.createElement('tbody');
    tableEl.appendChild(tbody);

    let currentRows = table.rows.slice();

    const inferredTypes = (table.types && table.types.length===table.headers.length)
      ? table.types.slice()
      : table.headers.map((_, col) => {
          let isDate=true, isNum=true;
          for (let i=0;i<Math.min(currentRows.length, 50);i++){
            const v = currentRows[i][col];
            if (v==null || v==='') continue;
            const n = Number(v);
            if (!isFinite(n)) isNum=false;
            const d = parseDateSmart(v);
            if (isNaN(d)) isDate=false;
            if (!isDate && !isNum) break;
          }
          return isDate ? 'date' : (isNum ? 'number' : 'text');
        });

    function pickBestDateColumn(){
      const byName = table.headers.findIndex(h =>
        h && /^(completed\s*on|completed|completion\s*date|date\s*completed|date\/time|date|datum)$/i.test(String(h).trim())
      );
      if (byName !== -1) return byName;
      let bestCol = -1, bestCount = 0;
      for (let c=0; c<table.headers.length; c++){
        let cnt = 0;
        for (let i=0; i<Math.min(currentRows.length, 200); i++){
          const v = currentRows[i]?.[c];
          if (v==null || v==='') continue;
          const d = parseDateSmart(v);
          if (!isNaN(d)) cnt++;
        }
        if (cnt > bestCount){ bestCount = cnt; bestCol = c; }
      }
      return bestCount > 0 ? bestCol : -1;
    }

    let sortCol = -1, sortDir = 1;

    function cmp(a,b,col){
      const t = inferredTypes[col];
      const va = a[col], vb = b[col];
      if (t==='date'){
        const na = parseDateSmart(va);
        const nb = parseDateSmart(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      } else if (t==='number'){
        const na = Number(va); const nb = Number(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      } else {
        const sa = String(va||'').toLowerCase();
        const sb = String(vb||'').toLowerCase();
        if (sa<sb) return -1;
        if (sa>sb) return 1;
        return 0;
      }
    }

    function updateSortIndicators(){
      const ths = thead.querySelectorAll('th .sort');
      ths.forEach((el, i)=>{
        el.textContent = (i===sortCol) ? (sortDir===1 ? '↑' : '↓') : '⇅';
        el.style.opacity = (i===sortCol) ? '1' : '.7';
      });
    }

    function displayValue(v, i){
      if (inferredTypes[i]==='date') return formatDateCell(v);
      if (inferredTypes[i]==='number') return String(v);
      return String(v ?? '');
    }

    const topInnerWidthSync = ()=> topInner.style.width = tableEl.scrollWidth + 'px';
    const syncFromTop   = ()=> wrap.scrollLeft = topScroll.scrollLeft;
    const syncFromBottom= ()=> topScroll.scrollLeft = wrap.scrollLeft;
    topScroll.addEventListener('scroll', syncFromTop, {passive:true});
    wrap.addEventListener('scroll', syncFromBottom, {passive:true});
    window.addEventListener('resize', ()=>requestAnimationFrame(topInnerWidthSync));

    function renderBody(){
      const q = (search.value||'').toLowerCase();
      tbody.innerHTML = '';
      currentRows.forEach(r => {
        if(q){
          const hit = r.some(v => String(v||'').toLowerCase().includes(q));
          if(!hit) return;
        }
        const tr = document.createElement('tr');
        r.forEach((v, i)=>{
          const td = document.createElement('td');
          const val = displayValue(v, i);
          if (inferredTypes[i]==='number') td.classList.add('cell-mono');
          if (i===assetCol) td.classList.add('asset');
          if (wideIdx.has(i)) td.classList.add('wide');
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      requestAnimationFrame(topInnerWidthSync);
    }

    function sortBy(colIdx){
      if(sortCol === colIdx){ sortDir *= -1; } else { sortCol = colIdx; sortDir = 1; }
      currentRows.sort((a,b)=> sortDir * cmp(a,b,colIdx) );
      updateSortIndicators();
      renderBody();
    }

    let completedCol = table.headers.findIndex(h =>
      h && /^(completed\s*on|completed|completion\s*date|date\s*completed)$/i.test(String(h).trim())
    );
    if (completedCol === -1) completedCol = pickBestDateColumn();
    if (completedCol !== -1){
      sortCol = completedCol;
      sortDir = 1;
      currentRows.sort((a,b)=> sortDir * cmp(a,b,completedCol) );
    }

    updateSortIndicators();
    renderBody();

    search.addEventListener('input', renderBody);

    dlBtn.onclick = ()=>{
      const esc =(s)=>('"'+String(s??'').replace(/"/g,'""')+'"');
      const lines = [ table.headers.map(esc).join(','), ...currentRows.map(row=>row.map(esc).join(',')) ].join('\r\n');
      const blob = new Blob([lines], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='work_history.csv'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    };
    openGs.onclick = async ()=>{
      try{
        await ensureAuth(); // admin only
        if (sheetId) window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/edit`, '_blank');
        else alert('Sheet ID not found');
      }catch(e){ alert('Admin sign-in failed: ' + (e.message || String(e))); }
    };

    setInterval(()=>{ adminBtns.style.display = (isAdmin() && isAdminSignedIn()) ? 'flex' : 'none'; }, 800);
  }

  async function drawWorksSheetView(bakery, machine, container){
    const entry = WORKS_SHEETS?.[bakery]?.[machine];
    if(!entry || !entry.sheetId){
      container.innerHTML = '<div class="small">No Google Sheet configured for this machine. Showing Drive folder instead.</div>';
      return null; // caller će onda nacrtati Drive listing (fallback)
    }
    try{
      container.innerHTML = '<div class="small">Loading Work History…</div>';
      const table = await fetchSheetTable(entry.sheetId, entry.sheetName||'Sheet1', entry.gid);
      renderWorksTable(container, table, entry.sheetId);
      return true;
    }catch(e){
      container.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`;
      return true;
    }
  }

  /* ===== Views ===== */
  function drawHome(){
    crumbsSet([{label:'Home'}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const wrap=document.createElement('div'); wrap.className='stack';

    ['Bakery 1','Bakery 2','Bakery 3','Other'].forEach(b=>{
      if (isOperator() && b==='Other') return; // operator ne vidi Other sekciju
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}`;
      a.innerHTML=`<h2>${b}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawBakery(b){
    if (isOperator() && b==='Other'){ go({}); return; } // operator blokiran
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const machines = MACHINES[b]||[];
    if(!machines.length){ drawMachine(b,'—'); return; }
    const wrap=document.createElement('div'); wrap.className='stack';
    machines.forEach(m=>{
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}`;
      a.innerHTML=`<h2>${m}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawMachine(b,m){
    if (isOperator() && b==='Other'){ go({}); return; } // safety
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m}`; card.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid';

    const isOtherGroup = (b==='Other');

    if (isOtherGroup){
      // U "Other" isključivo Documentation + Procedures
      ['documentation','procedures'].forEach(k=>{
        const meta=CATS[k];
        const a=document.createElement('a');
        a.className=`tile square ${meta.color}`;
        a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
        a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`;
        grid.appendChild(a);
      });
    } else {
      Object.entries(CATS).forEach(([k,meta])=>{
        // Opcija A: operator uopće ne vidi Work History
        if (isOperator() && (k==='works' || k==='electrical')) return;
        const a=document.createElement('a');
        a.className=`tile square ${meta.color}`;
        a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
        a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`;
        grid.appendChild(a);
      });
    }

    card.appendChild(grid);
    view.appendChild(card);
  }

  function folderIdFor(b,m,cat){ return FOLDERS?.[b]?.[m]?.[cat] || null; }

  function drawCategory(b,m,catKey){
    const cat=CATS[catKey]; if(!cat){ go({bakery:b,machine:m}); return; }

    // Opcija A: operator ne smije uopće vidjeti Work History ni Electrical
    if (isOperator() && (catKey==='works' || catKey==='electrical')) { go({bakery:b,machine:m}); return; }

    // "Other" nema works/electrical
    if (b==='Other' && (catKey==='works' || catKey==='electrical')) { go({bakery:b,machine:m}); return; }

    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}},{label:cat.title,to:{bakery:b,machine:m,cat:catKey}}]);

    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m} › ${cat.title}`; card.appendChild(h);

    const fid = folderIdFor(b,m,catKey);
    const hint = document.createElement('div'); hint.className='small'; card.appendChild(hint);
    function refreshHint(){
      if(!fid){ hint.style.display = ''; hint.innerHTML = '⚠️ Set Drive folder ID in <code>FOLDERS</code>.'; }
      else if (isAdminSignedIn()) { hint.style.display = ''; hint.innerHTML = `Folder ID: <code>${escapeHtml(fid)}</code>`; }
      else { hint.style.display = 'none'; hint.innerHTML = ''; }
    }
    refreshHint();

    const bar=document.createElement('div'); bar.className='toolbar';
    const search=document.createElement('input'); search.type='search'; search.placeholder='Search files';
    const refresh=document.createElement('button'); refresh.className='btn ghost'; refresh.textContent='Refresh';

    const adminBtn=document.createElement('button'); adminBtn.className='btn ghost'; adminBtn.textContent='Admin: Sign in';
    const openFolderBtn=document.createElement('button'); openFolderBtn.className='btn'; openFolderBtn.textContent='Open Drive folder (Admin)'; openFolderBtn.style.display='none';
    openFolderBtn.onclick=()=>{ if(fid) window.open(`https://drive.google.com/drive/folders/${fid}`, '_blank'); };

    if (isAdmin()){ bar.append(adminBtn, openFolderBtn); }
    bar.append(search, refresh); card.appendChild(bar);

    const list=document.createElement('div'); list.className='list'; card.appendChild(list);
    view.appendChild(card);

    const allowSet = getOpAllowSet();
    const isDocOrProc = (catKey==='documentation' || catKey==='procedures');

    async function publicListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const params=new URLSearchParams({
          q:`'${fid}' in parents and trashed=false`,
          fields:'files(id,name,modifiedTime,mimeType,webViewLink)',
          orderBy:'modifiedTime desc', pageSize:'100', key:API_KEY,
          supportsAllDrives:'true', includeItemsFromAllDrives:'true'
        });
        const res=await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
        if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
        let items=(await res.json()).files||[];

        const s=(search.value||'').toLowerCase();
        if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));

        if (isOperator()){
          if (isDocOrProc){
            items = items.filter(f => allowSet.has(f.id));
            if (!items.length){ list.innerHTML = '<div class="small">No files allowed for operator yet.</div>'; return; }
          } else {
            list.innerHTML = '<div class="small">Not permitted.</div>'; return;
          }
        }

        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }

        renderFileRows(items, false);
      }catch(e){ list.innerHTML=`<div class="small">Public list error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    async function privateListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const q=`'${fid}' in parents and trashed=false`;
        const res=await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink)', orderBy:'modifiedTime desc', pageSize:100, supportsAllDrives:true, includeItemsFromAllDrives:true });
        let items=res.result.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        renderFileRows(items, true);
      }catch(e){ list.innerHTML=`<div class='small'>Error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    function renderFileRows(items, adminMode){
      list.innerHTML='';
      items.forEach(f=>{
        const row=document.createElement('div'); row.className='item';

        const title=document.createElement('a'); title.className='title'; title.href='#';
        title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, adminMode); };
        const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():''; 
        title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;

        const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

        // Admin: toggle Allow operator (samo za doc/proc)
        if (adminMode && isAdmin() && isDocOrProc){
          const lbl=document.createElement('label'); lbl.className='small'; lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = getOpAllowSet().has(f.id);
          cb.onchange=()=> setOpAllow(f.id, cb.checked);
          lbl.append(cb, document.createTextNode('Allow operator'));
          right.appendChild(lbl);
        }

        const dl=document.createElement('a'); dl.className='icon-btn';
        dl.href = adminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : publicDownloadUrl(f.id);
        dl.target='_blank'; dl.rel='noopener';
        dl.title='Download';
        dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        right.appendChild(dl);

        if (adminMode && isAdmin()){
          const del=document.createElement('button'); del.className='icon-btn'; del.title='Delete';
          del.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M10 7v12m4-12v12M9 7l1-2h4l1 2M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          del.onclick=async()=>{ if(!confirm('Delete file?')) return;
            try{ await gapi.client.drive.files.delete({fileId:f.id}); await privateListFiles(); }
            catch(e){ alert('Delete failed: '+(e.result?.error?.message||e.message)); } };
          right.appendChild(del);
        }

        row.append(title, right);
        list.appendChild(row);
      });
    }

    // INIT
    publicListFiles();
    refresh.onclick = publicListFiles;
    search.oninput = publicListFiles;

    if (isAdmin()){
      adminBtn.onclick = async () => {
        try{
          await ensureAuth();
          refreshHint(); openFolderBtn.style.display=''; adminBtn.style.display='none';
          refresh.onclick = privateListFiles; search.oninput = privateListFiles; await privateListFiles();
          const signOut = document.createElement('button'); signOut.className='btn ghost'; signOut.textContent='Admin: Sign out';
          signOut.onclick = ()=>{ accessToken=null; alert('Signed out. Refresh to return to public mode.'); };
          bar.append(signOut);
        }catch(e){ alert('Sign-in failed: ' + (e.message || String(e))); }
      };
    }

    // Ako je kategorija Work History i postoji Sheet mapping → nacrtaj tablicu iznad liste,
    // a Drive listing služi kao fallback SAMO ako mapping ne postoji (po tvojoj potvrdi “Da, da”).
    if (catKey==='works'){
      // Ako operator nekako dođe URL-om — zaštita (opcija A)
      if (isOperator()){ go({bakery:b,machine:m}); return; }

      const sheetWrap = document.createElement('div');
      sheetWrap.className='card';
      sheetWrap.style.marginTop='12px';
      sheetWrap.innerHTML = '<div class="small">Loading Work History…</div>';
      view.insertBefore(sheetWrap, card); // prikaži tablicu iznad liste

      const loaded = await drawWorksSheetView(b,m,sheetWrap);
      if (loaded===null){
        sheetWrap.innerHTML = '<div class="small">No Sheet mapping found — showing Drive listing below.</div>';
      }
    }
  }

  /* ===== Global Search ===== */
  function buildFolderIndex(){
    const out=[];
    for(const bakery of Object.keys(FOLDERS||{})){
      const machinesObj = FOLDERS[bakery] || {};
      for(const machine of Object.keys(machinesObj)){
        const cats = machinesObj[machine] || {};
        for(const catKey of Object.keys(cats)){
          const folderId = cats[catKey]; if(folderId){ out.push({ bakery, machine, cat:catKey, folderId }); }
        }
      }
    }
    return out;
  }
  const FOLDER_INDEX = buildFolderIndex();
  function escapeQueryForDrive(name){ return (name||'').replace(/'/g, "\\'"); }

  async function searchFolderPublic(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const params = new URLSearchParams({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:'50', key:API_KEY, supportsAllDrives:'true', includeItemsFromAllDrives:'true' });
    const res = await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
    if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
    const data = await res.json(); return data.files || [];
  }
  async function searchFolderPrivate(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const res = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:50, supportsAllDrives:true, includeItemsFromAllDrives:true });
    return res.result.files || [];
  }

  function renderSearchResultsHeader(query){
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`Search results for “${query}”`; card.appendChild(h);
    const small=document.createElement('div'); small.className='small';
    small.textContent = isAdminSignedIn() ? 'Searching all mapped Drive folders (admin mode)…' : 'Searching public files in all mapped Drive folders…';
    card.appendChild(small);
    const list=document.createElement('div'); list.className='list'; list.id='globalResults'; card.appendChild(list);
    view.appendChild(card);
  }

  function appendSearchItem(container, meta, f, adminMode){
    const row=document.createElement('div'); row.className='item';
    const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, adminMode); };
    const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
    const path = `${meta.bakery} › ${meta.machine} › ${CATS[meta.cat]?.title||meta.cat}`;
    title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(path)} • ${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
    const dl=document.createElement('a'); dl.className='icon-btn';
    dl.href = adminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;
    dl.target='_blank'; dl.rel='noopener';
    dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    row.append(title, dl); container.appendChild(row);
  }

  async function drawSearch(query){
    crumbsSet([{label:'Home',to:{}},{label:`Search: ${query}`,to:{q:query}}]);
    renderSearchResultsHeader(query);
    const list = document.getElementById('globalResults');
    list.innerHTML = '<div class="small">Scanning mapped folders…</div>';
    const concurrency = 6; let idx = 0, resultsCount = 0; list.innerHTML = '';

    const allowSet = getOpAllowSet();

    async function worker(){
      while(idx < FOLDER_INDEX.length){
        const i = idx++; const meta = FOLDER_INDEX[i];

        // Operator pretražuje samo Documentation/Procedures i samo allowed fileove
        if (isOperator() && !(meta.cat==='documentation' || meta.cat==='procedures')) continue;

        try{
          let files = isAdminSignedIn() ? await searchFolderPrivate(meta.folderId, query) : await searchFolderPublic(meta.folderId, query);
          if (isOperator()){
            files = files.filter(f => allowSet.has(f.id));
          }
          files.forEach(f => { appendSearchItem(list, meta, f, isAdminSignedIn()); resultsCount++; });
        }catch(e){ /* ignore per-folder errors */ }
      }
    }
    await Promise.all(Array.from({length: Math.min(concurrency, FOLDER_INDEX.length)}, worker));
    if(resultsCount === 0){ list.innerHTML = '<div class="small">No results.</div>'; }
  }

  /* ===== Router ===== */
  function draw(){
    refreshHeaderAuth();
    const p=params(); const b=p.get('bakery'); const m=p.get('machine'); const c=p.get('cat'); const q=p.get('q');

    if(q){ drawSearch(q); return; }
    if(!b){ drawHome(); return; }
    if(b && !m){ drawBakery(b); return; }
    if(b && m && !c){ drawMachine(b,m); return; }
    if(b && m && c){ drawCategory(b,m,c); return; }
  }

  /* ===== Startup ===== */
  window.addEventListener('load', ()=>{
    // inicijalni tiles (Home)
    const stack = document.getElementById('homeStack');
    if (stack){
      stack.innerHTML = '';
      ['Bakery 1','Bakery 2','Bakery 3','Other'].forEach(B=>{
        if (isOperator() && B==='Other') return;
        const a=document.createElement('a');
        a.className='tile';
        a.href='?bakery=' + encodeURIComponent(B);
        a.innerHTML = `<h2>${B}</h2><p>Open</p>`;
        stack.appendChild(a);
      });
    }
    draw();
  });

  /* ===== Global search form ===== */
  const gsForm = document.getElementById('globalSearchForm');
  const gsInput = document.getElementById('globalSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  if(gsForm){
    gsForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const q = (gsInput.value||'').trim();
      if(q){ go({ q }); clearBtn.style.display=''; } else { go({}); clearBtn.style.display='none'; }
    });
  }
  if(clearBtn){ clearBtn.addEventListener('click', ()=>{ gsInput.value=''; go({}); clearBtn.style.display='none'; }); }

  /* ===== Multi-role PIN gate ===== */
  const lock = document.getElementById('lockscreen');
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  const pinMsg = document.getElementById('pinMsg');

  function doUnlock(role){
    sessionStorage.setItem('unlocked','1');
    sessionStorage.setItem('role', role);
    lock.style.display = 'none';
    pinMsg.style.display = 'none';
    pinInput.value='';
    refreshHeaderAuth();
    draw();
  }

  function checkPin(){
    const val=(pinInput.value||'').trim();
    const role = ROLE_PINS[val];
    if (role){
      doUnlock(role);
    } else {
      pinMsg.style.display = 'block';
      lock.animate([
        { transform:'translateX(0px)' },
        { transform:'translateX(-6px)' },
        { transform:'translateX(6px)' },
        { transform:'translateX(-4px)' },
        { transform:'translateX(4px)' },
        { transform:'translateX(0px)' }
      ], { duration: 250 });
      setTimeout(()=>pinMsg.style.display='none', 1800);
    }
  }
  pinBtn.addEventListener('click', checkPin);
  pinInput.addEventListener('keypress', e=>{ if(e.key === 'Enter') checkPin(); });

  // auto-hide lock ako je već otključano
  if(sessionStorage.getItem('unlocked') === '1'){
    doUnlock(sessionStorage.getItem('role')||'operator');
  }
  </script>
</body>
</html>

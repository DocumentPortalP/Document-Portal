<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Documentation Portal</title>
<style>
  :root{ --bg:#f7fafc; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --brand:#2563eb; --line:#e2e8f0; --zebra:#f8fafc; --hover:#eef2ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(4px)}
  .hwrap{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
  .title{font-weight:800;letter-spacing:.2px;flex:1 1 auto}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .stack{display:flex;flex-direction:column;gap:10px}
  .tile{display:block;background:linear-gradient(135deg,#fff,#f8fafc);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:18px 16px;text-decoration:none;color:inherit}
  .tile h2{margin:0 0 4px 0;font-size:1.1rem}
  .tile p{margin:0;color:var(--muted);font-size:.9rem}
  .tile:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .square{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
  .c1{background:#fef3c7}.c2{background:#dbeafe}.c3{background:#d1fae5}.c4{background:#f3e8ff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px}
  .crumbs a{color:var(--brand);text-decoration:none}
  .crumbs .sep{opacity:.45;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid #cbd5e1}
  .btn.badge{font-size:.9rem;padding:6px 10px}
  .small{font-size:.86rem;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;align-items:center;gap:12px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .item a.title{flex:1;text-decoration:none;color:inherit}
  .item a.title:hover{text-decoration:underline}
  .item .meta{font-size:.82rem;color:var(--muted);margin-top:4px}
  .icon-btn{min-width:34px;min-height:34px;border-radius:999px;border:1px solid #cbd5e1;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .icon-btn svg{width:16px;height:16px;display:block}

  /* Data table */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:0 0 12px 12px;background:#fff}
  table.data{width:100%;border-collapse:separate;border-spacing:0;font-size:0.96rem}
  .data thead th{position:sticky;top:0;z-index:1;background:#f8fafc;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap;user-select:none;cursor:pointer}
  .data thead th .hint{font-weight:600}
  .data thead th .sort{opacity:.7;margin-left:6px;font-size:.9em}
  .data tbody td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:top}
  .data tbody tr:nth-child(odd){background:var(--zebra)}
  .data tbody tr:hover{background:var(--hover)}
  .data .cell-mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.9em;color:#334155}
  .data td, .data th { overflow-wrap:anywhere; word-break:break-word; }
  .data td.wide, .data th.wide { min-width:420px; }
  .data td.asset, .data th.asset { min-width:260px; white-space:nowrap; }

  .scroll-x-top{overflow-x:auto;overflow-y:hidden;height:14px;background:#fff;border:1px solid var(--line);border-bottom:0;border-radius:12px 12px 0 0;}
  .scroll-x-top::-webkit-scrollbar{height:12px}
  .scroll-x-top::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
  .scroll-x-top::-webkit-scrollbar-track{background:#f8fafc;border-radius:8px}

  footer{height:1px}

  /* --- Responsive header fix --- */
  @media (max-width:700px){
    .hwrap{flex-direction:column;align-items:stretch;gap:6px}
    #globalSearchForm{width:100%;order:2;justify-content:space-between}
    #roleArea{width:100%;display:flex;justify-content:space-between;align-items:center;order:3}
    #roleBadge{margin-left:0}
    #logoutBtn{margin-left:auto}
  }

  /* ===== Preview pinch-zoom (ONLY inside modal) ===== */
  #previewViewport{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
    background:#fff;
  }
  #previewZoom{
    position:absolute;
    inset:0;
    transform-origin: 0 0;
    will-change: transform;
  }
  /* Transparent layer to capture pinch/pan gestures */
  #previewGestureLayer{
    position:absolute;
    inset:0;
    background:transparent;
    touch-action:none;            /* ključ za mobitel */
    cursor: grab;
  }
  #previewGestureLayer:active{ cursor: grabbing; }
</style>
</head>
<body>
  <header>
    <div class="hwrap">
      <div class="title">Documentation Portal</div>

      <form id="globalSearchForm" style="margin-left:auto;display:flex;gap:8px;align-items:center;flex:1 1 100%;max-width:100%;">
        <input id="globalSearchInput" type="search" placeholder="Search all files…" aria-label="Search" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;min-width:180px">
        <button class="btn" type="submit">Search</button>
        <button class="btn ghost" id="clearSearchBtn" type="button" style="display:none">Clear</button>
      </form>

      <div id="roleArea" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;width:auto;">
        <div id="roleBadge" class="small" style="padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;color:#2563eb;font-weight:700;display:none;white-space:nowrap"></div>
        <button id="logoutBtn" class="btn ghost" style="display:none;white-space:nowrap;">Logout</button>
      </div>
    </div>
  </header>
  
  <!-- PIN lock -->
  <div id="lockscreen" style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f7fafc;z-index:9999;">
    <h2 style="margin-bottom:12px;font-family:Inter,sans-serif;color:#1e293b;">Enter Access Code</h2>
    <input type="password" id="pinInput" placeholder="Code" style="padding:10px 14px;border:1px solid #cbd5e1;background:#fff;color:#1e293b;border-radius:8px;font-size:1rem;">
    <button id="pinBtn" style="margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;">Unlock</button>
    <p id="pinMsg" style="color:#dc2626;margin-top:10px;display:none;">Wrong code</p>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewBackdrop" style="position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;z-index:9998;">
    <div id="previewCard" style="position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);width:min(100vw,1100px);height:min(100vh,88vh);background:#ffffff;border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #e2e8f0;background:#f8fafc;padding:8px 12px;">
        <div id="previewTitle" style="font-weight:600;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Preview</div>
        <div style="display:flex;gap:8px;align-items:center">
          <a id="previewDownload" class="btn" style="text-decoration:none;padding:6px 10px;border-radius:10px;background:#2563eb;color:#fff">Download</a>
          <button id="previewClose" class="btn ghost" style="padding:6px 10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b">Close</button>
        </div>
      </div>
      <div id="wm" style="position:absolute;inset:0;pointer-events:none;display:none;align-items:center;justify-content:center;z-index:2">
        <div style="transform:rotate(-25deg);font-weight:800;font-size:48px;color:#0f172a12">CONFIDENTIAL — Documentation Portal</div>
      </div>

      <!-- UPDATED PREVIEW BODY: adds zoom/pinch layer only inside modal -->
      <div id="previewBody" style="width:100%;height:calc(100% - 46px);background:#fff">
        <div id="previewViewport">
          <div id="previewZoom">
            <iframe id="previewFrame" style="width:100%;height:100%;border:0;display:block"></iframe>
            <video id="previewVideo" style="display:none;width:100%;height:100%" controls playsinline></video>
          </div>
          <!-- layer that captures pinch/pan ONLY in this window -->
          <div id="previewGestureLayer" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <nav class="crumbs" id="crumbs"></nav>
    <section id="view">
      <div class="stack" id="homeStack"></div>
    </section>
  </main>
  <footer></footer>

  <!-- External SDKs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <!-- Main App Script -->
  <script>
  /******** CONFIG ********/
  const CLIENT_ID = '383558298407-ouglj5g19etrso6mur70q2h1pu6i6ahi.apps.googleusercontent.com';
  const API_KEY   = 'AIzaSyBJ1X9GAoM9YGBHKt9VFLeAci4pMRPosmw';
  const SCOPES    = 'https://www.googleapis.com/auth/drive';

  /* ===== Structure ===== */
  const MACHINES = {
    'Bakery 1': ['Mixing','Fermentation','Fritsch','Proover','Oven','Cooler','Freezer', 'Bar Marker'],
    'Bakery 2': ['Mixing','Fermentation','Spiro','Scarifier','Retarder','Rademaker','Proover','Oven','MIB','Freezer','Cooler','AHU'],
    'Bakery 3': ['Site 1 Packing','Site 2 Packing','Paletiser','Retail'],
    'Other':    ['General']
  };

  const FOLDERS = {
    'Bakery 1': {
      'Fritsch':      {documentation:'1TtOQv5EThkDJ4c23I7epY40kpL_14M-q', works:'134xHl2fufzon1ran2kB2WsqEkQK4m5EH', electrical:'18DxayxAeo0s9q88h7KGOr21zfPQdstgG', procedures:'1QkNnG6d-RBw2j6EYooxR92vcE9phz0FS'},
      'Mixing':       {documentation:'1DoHLHHWodvbwTHjhirZBM4BhlDksI_qw', works:'1YuodKUqBDehzsKK3iFk0GNLHf2vEmZw9', electrical:'1v4ZHV40KiQPs2DwP52mAWTQ3o4Yju2Os', procedures:'1HNFXp1e8SFM-b1K809a5RL8c-oTGj3mv'},
      'Oven':         {documentation:'1y5xdJ5qqnYrcHieec6_5oaID2EuZ9n1f', works:'1vmb4uS7fsUy8dmcvFGDQAfcTVVyO0kTj', electrical:'1gnZxD4TedfURVOD3mOBRNA3MRTqyrO-s', procedures:'1u30duEKrD3ZMYey62Jy_qFI99D8T9Agx'},
      'Fermentation': {documentation:'15coru1xjzm8apuySDx0Rkf1Yihwkiny8', works:'1cSQ3y0Krwpsa6Jmny4RNGNYmNMdEEEKe', electrical:'1Hm7sc0le89MaGoyGT9xUHGu8EUxPRXlZ', procedures:'1iFxs_EDCTJPXEcOYFBqdVaK2l-tHCwKa'},
      'Proover':      {documentation:'1is9dH0PYJztEGdLvrQvGTPmNChy2YUZR', works:'1d3WMB-UponsZlvrTCLe4X9SSfdwELI2o', electrical:'1OPg5oxNYMsVw22ClRQpVGrmdv_sFHcsd', procedures:'1y-XxNHUbSepwnYZ2JTf6tKSnfsc8zZWz'},
      'Freezer':      {documentation:'1fEougP82KxPmNTgXKZk5-MgVz9GbvUl4', works:'1tm3d974D4pAXgBgw7FeGB6rm1oSGP1_I', electrical:'1aLRFUMsUvLen7MKaiPCUZ7xn5OpBvguP', procedures:'10U-eNWpipgLvxbm8Gn33IQOnuOLqA8Fg'},
      'Cooler':       {documentation:'1DytWdFirwApX6iLUMFG_jDSQvAkTWqEw', works:'1kSI1l5bxugVx9n1Atla22cLHicEOu2D8', electrical:'1pLqnD3W0Ku1pPMQbTa5vzKyi4HKvzKKo', procedures:'1-AY6xw5axJ6MGA0RClSTejpfraXTTd63'},
      'Bar Marker':   {documentation:'1VOknQ7i9Bhi7p6jX5QO0kcHdha_klc2R', works:'11Rxd0z5UQQj1izH6noekwQ9FmNbtU8x4', electrical:'1MEGNYNDeQ0nyflFuEGQ7wyXdTbhGZ60g', procedures:'1PE5WRvX1Q7ZW9OY27697lV-Z8AHtG_ra'}
    },
    'Bakery 2': {
      'Mixing':       {documentation:'1zudP8sLtYeXdPDUiTQX8ncJEiFNi5PGp', works:'1h4VdDBSbGRiwkorV8KfSy9NeYF3Aq0fr', electrical:'1PchyAchzNw5bdLjAGyK0xsZ253WteLxU', procedures:'1O1cUvvOyqmFYZM8tGW1vRDu76EaK1C6-'},
      'Fermentation': {documentation:'1BAUGAc52IPeHnR5f4raZ523ulPejyi9R', works:'1cLviY22iu7dFzpOiGNDf96ejXkl0dpCk', electrical:'1JIAqmNUPuQiDwgbLxlXCPPwHzCuP3788', procedures:'1fkvMcqu8koQJ4qJtL4_Sv1-_7wY69Ny7'},
      'Spiro':        {documentation:'10JnBXfbcYIGfeiquWzFzSguphIOq3pUf', works:'1mzpcxhHOxvr0WPY2wmq-hlcwGGyTHHyH', electrical:'1QTNlFpETS4VlmWJo3fsi3nNXe4A9Wnf9', procedures:'10gE02-AkbNf5PqxSfX_L_CJ1-kwgBTl8'},
      'Scarifier':    {documentation:'1Lc7zAzGJdsZRHYu6zJotw3UWqOxnSauJ'.replace('5',''), works:'1Xwhy2UH3pOUlfRypjqpVK5X1-icv2mR6', electrical:'1HHYmBtNllKX5shoVMJtiIqYonIMlc8g_', procedures:'1JXB_iQsJa8QveOVKDZKbML-jDPNnVMdB'},
      'Retarder':     {documentation:'1PyKR_lK7Ts9AfxwVNHgzCka7SgnCBAYX', works:'1oQC9jLCFmLtUVMwTanNnD50_juZm-H6t', electrical:'1V_iHswv8gWFEPZA4tEjoPic54fcJ4bCi', procedures:'1s3O6P1LPYRUblYSECrGPkGUFiIqzDAPP'},
      'Rademaker':    {documentation:'1fW0ZDXRKGDV83xDw3sEJvWV9ukTvBkmC', works:'1mOX5mGPjxwEy5incajN42hPNYr7DQgK6', electrical:'1WY6walad34lCcnXlDS_YHc1nfGeHQa0n', procedures:'1PcGT1N-TGPBcTkDVU5ElLEmIwJnAkvaS'},
      'Proover':      {documentation:'18FQjqiPEdoWccfcWj1QacgXTjG5eR0ye', works:'1M6tHWqPQmo8dbo1A-KKa3O9i9E6c0SvU', electrical:'1xKPYZEGfojToDwrRiluD96sCH6j0UpD1', procedures:'1iVp3SOPCdW19tdfl1sunwac7RpwwlcQF'},
      'Pattyn Tilting Conveyer':{documentation:'10s3jPwp6dROLtu1VtXxy6s90ekclFKeL', works:'1lRj5oUVMFNzm4dmAiK_Hs-dTXcNrLPDL', electrical:'1JRztMfGW-mK2Q2aaanLOeO_M6dUB6Co-', procedures:'1vaoFOUtk3GwbiOcoZGwisU2lXS3JWDr1'},
      'Packing':      {documentation:'1b7lejvDhl3t-QtXXtcwYQrfinb1A3d37', works:'14DaubNbxDI4kHkY1lybR5aO8BDY5FXkz', electrical:'1XT0X0llTt_MC0f-1YGik426rTD8Iv8Wa', procedures:'1g8hL-uQkGgGeeBHgoL_bqNcLigN8aSj8'},
      'Oven':         {documentation:'1B7FTUY4FPyBS1t8pqQ5GqDtemgpYQ74z', works:'1wR6ZkTK97KY-M8Maf-b9-2GbigdcNU0Y', electrical:'1pWjIvbrHLRxtA3POj8paD8tche25aQXx', procedures:'1oncf1Y_zHY4mYywLvEjs7S8gZpbKVlCe'},
      'MIB':          {documentation:'1U7vrSwXzraP5k2qXetBknw1sMUwEyaJ7', works:'1KHJD6Ym4gcV6Lj5yGMUJM7tIuOz11eYu', electrical:'13reFyzrc9hqbnINlS9mszlGAnuTRPr1C', procedures:'1CVlhpzWsvQ4jnJL77Cy64FC-jRILkHLs'},
      'Freezer':      {documentation:'1FFyFlKJEI4hfrxQmuKPQlDkOz72YCT5C', works:'1n52QVId2cUAG-LBUueWEoGyPZTOYb2SD', electrical:'1xqcwh5GvmZgSkCyffzQNINw4P_91W4Df', procedures:'1X14Fgcb8rESKIGQNXVo1bVT9cYn_f4s6'},
      'Cooler':       {documentation:'1R76AuyOoR-s0Bg9XmR3rYvvQN6oKm9Po', works:'16zlYojFfOTrSFgd7th5qPrJPJ5ceM2-z', electrical:'1SFVbg_a2mcStLcTzZ2i8F-skeZ6F1Hvq', procedures:'15lIE4UUaIBiXXTEz_zPHGo9ciCI0H2lT'},
      'Baggers':      {documentation:'1HzHV6G7HZFJ-kjC8xsXp5HyO-YXd5MaU', works:'1jB5B1NEEhkDmUjhoJeMJ476I6hgU6OtK', electrical:'17TFo6H4iR3LniJ-hDIA_7U8KhgGeatKh', procedures:'1igbb3Co4Fgv8ZWySAwGt34BD8qLXAlv3'},
      'AHU':          {documentation:'1HhUMMmTdLqLssVd0n8ELraF7vHEypERT', works:'1IONOZH5Oh20bRQiOKFdrBACjnmECXF6d', electrical:'1Qx3Izd-STjJ34HO4qoUW-va6g_62yCow', procedures:'1N_94znXfxOeYlChDRUWo2O7NCRCAFYYI'}
    },
    'Bakery 3': {
      'Site 1 Packing': {documentation:'1wVIP0pnbY9-bvx4Khb50wl9Ni2uvP8ZI', works:'1fO8rMJ6tkmg2NrPq4esZDb_Tzz554xgT', electrical:'1I587knnvHq1WarvZ9MdlezqooSIoQYBV', procedures:'1Ao-nAw_X8UAUnkaETxUlOkfIXH_C80QA'.replace('d','')},
      'Site 2 Packing': {documentation:'17DXdFMXZBpf9mtZ4c5ZrGsSZTbfkBYft', works:'1_GcauA20-3UKzkFYpLgM9aEcZu6ZL3Q7', electrical:'1LXWzf4qDRATSiXnfgy1gguOyR5qOYISY', procedures:'1iUSiN9lkyd-Cfl2eWtgfeOX8U42dE4fQ'},
      'Paletiser':      {documentation:'1wVIP0pnbY9-bvx4Khb50wl9Ni2uvP8ZI', works:'1fO8rMJ6tkmg2NrPq4esZDb_Tzz554xgT', electrical:'1I587knnvHq1WarvZ9MdlezqooSIoQYBV', procedures:'1Ao-nAw_X8UAUnkaETxUlOkfIXH_C80QA'.replace(' ','')},
      'Retail':         {documentation:'1wVv6BzVnpgv7PDw7rPmSqFUCfp2RVo8d', works:'1_HXYuj17giRiwPIWE_AJqwYCOgCpAMBv', electrical:'1rvYAmcDNc-sKCnZlyQRXnqC3ujkhLiXl', procedures:'1BG_ajXL8jdBiwOGYoUncJazdOUnoWZS6'}
    },
    'Other': {
      'General':       {documentation:'1gAQ3GKN_Du_eaomGF_Z5th-YwpZQXDNK', procedures:'1s1x0wV3yTgg2hipH41R7DoczCvnlvLA6'}
    }
  };

  /* Work History → Google Sheet mapping */
  const WORKS_SHEETS = {
    'Bakery 1': {
      'Fritsch': {sheetId: '1Zbw2tdWHwtmGPmEbPB-zwCISkaU0uE9V', sheetName: 'Work Histories', gid: '376639293'},
      'Mixing': { sheetId: '1sqLOozThUlEjMzonVPbdaScnSlCq36xP', sheetName: 'Work Histories', gid: '598593226' },
      'Cooler': { sheetId: '1sqLOozThUlEjMzonVPbdaScnSlCq36xP', sheetName: 'Work Histories', gid: '598593226'},
      'Freezer': {sheetId: '1XPuNPqiJOrGaiTkvZqPUKjo4t-ArcxrC', sheetName: 'Work Histories', gid: '1982828363'},
      'Fermentation':{sheetID: '1-fqWwxyiBh2Bg2vURBYhvtN6hNeyub0a', sheetName:'Work Histories', gid: '240637548'},
      'Oven' :{ sheetId: '1lv_wj7vUF0CPEDlG_AJy6pr07I_UgueB', sheetName:'Work Histories', gid: '1201491591'},
      'Proover':{ sheetId: '1qcZkic09W3IVQIrciOPu8F3u3aRuAret', sheetName: 'Work Histories', gid: '629516588'},          
    },
    'Bakery 2': {
      'AHU' : {sheetId: '1Bav0okr_EOD_BUcYdTyg4ZLbtPXg0c6r', sheetName: 'Work Histories', gid: '1465343950'},
      'Baggers': {sheetId: '1TDd3HN4VCdaIMVqrEqKSpP-hOIB1qF5G', sheetName: 'Work Histories', gid: '1866850271'},
      'Cooler': {sheetId: '1UH2bXg2xNxeaLwBrgoJB0bLkHBrPw_G_', sheetName: 'Work Histories', gid: '590925651'},
      'Fermentation' :{sheetId: '1KtRYBhlDtBiMfNoXZbH15RWEaXBPanB1', sheetName: 'Work Histories', gid: '1773358127'},
      'Freezer' :{sheetId: '142g28ImYvkIISMY3tIxx9-HAc2HTsu4P', sheetName: 'Work Histories', gid: '1108561148'},
      'Mixing' :{sheetId: '1cKkULO4w0NMgOm8xCWcJpgi2fnAEEAKf', sheetName: 'Work Histories', gid: '1291120270'},
      'Oven' :{sheetId: '1ji5vmcbBJcOKlYg3lQ1tPAj-sDB-h_pF', sheetName: 'Work Histories', gid:'542344704'},
      'Proover' :{sheetId: '1nSY7rnpL5jPbnwBkWflITI357lGYRJgJ', sheetName: 'Work Histories', gid: '580369016'},
      'Rademaker' :{sheetId:'1SP_P1cBAmdS8JnCwXq2L8qH26SvFVJpB', sheetName: 'Work Histories', gid: '176625201'},
      'Retarder' :{sheetId: '1qZQKz77AHlAonryimU-pUokwgFTReden', sheetName: 'Work Histories', gid: '1302414895'},
      'Scarifier' :{sheetId: '1jmi0teTEGZBlvvu2L5aIg_GFcL6Xzq96', sheetName: 'Work Histories', gid:'525823593'},
      'Spiro' :{sheetId: '1-t2YrC3Wwox1jpOcZo0Xxzs6NKdUALZK', sheetName: 'Work Histories', gid:'620703835'},  
    },
    'Bakery 3': {
      'Site 2 Packing' :{sheetId: '19C1b-GwMOWAPFhqUx0lzwyuIbb9HkK81', sheetName: 'Work Histories', gid:'1461447237'},
      'Site 1 Packing' :{sheetId: '1dqNSJjcg5YHry0P44y36IfUPt17776dZ', sheetName: 'Work Histories', gid:'1827174219'},
      'Paletiser' :{sheetId: '1YYy_q1z1VTjvP8qAOlhitF17Q1GeOJpq', sheetName: 'Work Histories', gid:'1730089513'},
      'Retail' :{sheetId: '1avLAoAiyHtCNOyYkUffT7iCWQ_N54yk2', sheetName: 'Work Histories', gid:'1258265858'},
    }
  };

  const CATS = {
    documentation: { title:'Documentation',   color:'c1', desc:'User manuals & technical docs' },
    works:         { title:'Work History',    color:'c2', desc:'Repairs, interventions' },
    electrical:    { title:'Electrical Diagrams', color:'c3', desc:'Wiring & schematics' },
    procedures:    { title:'Procedures',      color:'c4', desc:'SOPs & guides' }
  };

  /* ===== Utils ===== */
  function params(){ return new URLSearchParams(location.search); }
  function go(obj){ const u=new URL(location.href); u.search=new URLSearchParams(obj).toString(); history.pushState({},'',u); draw(); }
  window.addEventListener('popstate', draw);
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  function crumbsSet(items){
    const el = document.getElementById('crumbs');
    el.innerHTML='';
    items.forEach((it,i)=>{
      const a=document.createElement('a');
      a.href='javascript:void(0)';
      a.textContent=it.label;
      a.onclick=()=>{ go(it.to||{}); };
      el.appendChild(a);
      if(i<items.length-1){
        const s=document.createElement('span');
        s.className='sep'; s.textContent='›'; el.appendChild(s);
      }
    });
  }

  /* ===== Roles / PIN ===== */
  const ROLE_PINS = { '1111':'operator', '2906':'engineer', '1782':'admin' };
  function getRole(){ return sessionStorage.getItem('role') || 'operator'; }
  function isOperator(){ return getRole()==='operator'; }
  function isEngineer(){ return getRole()==='engineer'; }
  function isAdmin(){ return getRole()==='admin'; }

  const roleBadge = document.getElementById('roleBadge');
  const logoutBtn = document.getElementById('logoutBtn');
  function refreshHeaderAuth(){
    const role = getRole();
    if (sessionStorage.getItem('unlocked')==='1'){
      roleBadge.style.display = '';
      roleBadge.textContent = role;
      logoutBtn.style.display = '';
    } else {
      roleBadge.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  }
  logoutBtn?.addEventListener('click', ()=>{
    sessionStorage.removeItem('unlocked');
    sessionStorage.removeItem('role');
    location.href = location.pathname;
  });

  // Operator allow-list (global, za Documentation & Procedures)
  const OP_ALLOW_KEY = 'operatorAllowList';
  function getOpAllowSet(){ try{ return new Set(JSON.parse(localStorage.getItem(OP_ALLOW_KEY)||'[]')); }catch{ return new Set(); } }
  function setOpAllow(fileId, allow){
    const s = getOpAllowSet(); if(allow) s.add(fileId); else s.delete(fileId);
    localStorage.setItem(OP_ALLOW_KEY, JSON.stringify([...s]));
  }

  /* ===== Google Drive/Auth ===== */
  let accessToken=null,gapiReady=false;
  async function ensureGapi(){
    if(gapiReady) return;
    await new Promise(r=>gapi.load('client',r));
    await gapi.client.init({apiKey:API_KEY,discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
    gapiReady=true;
  }
  async function ensureAuth(){
    if(!isAdmin()) throw new Error('Only admin can sign in.');
    if(accessToken) return accessToken;
    await ensureGapi();
    return new Promise((res,rej)=>{
      const c=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID, scope:SCOPES,
        callback:r=>{ if(r&&r.access_token){accessToken=r.access_token;res(accessToken);} else rej(new Error('No token')); }
      });
      c.requestAccessToken({prompt:'consent'});
    });
  }
  function isAdminSignedIn(){ return !!accessToken; }
  function publicDownloadUrl(fileId){ return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`; }

  async function fetchPrivateBlob(fileId){
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers:{'Authorization':'Bearer '+accessToken} });
    if(!r.ok) throw new Error('Fetch failed '+r.status);
    return await r.blob();
  }

  /* ===== Preview helpers ===== */
  const previewBackdrop = document.getElementById('previewBackdrop');
  const previewFrame   = document.getElementById('previewFrame');
  const previewVideo   = document.getElementById('previewVideo');
  const previewTitleEl = document.getElementById('previewTitle');
  const previewCloseBtn= document.getElementById('previewClose');
  const previewDownload= document.getElementById('previewDownload');
  const wmEl           = document.getElementById('wm');

  /* ===== Preview pinch-zoom refs ===== */
  const previewViewport = document.getElementById('previewViewport');
  const previewZoomEl   = document.getElementById('previewZoom');
  const gestureLayer    = document.getElementById('previewGestureLayer');

  function setGestureEnabled(on){
    if (!gestureLayer) return;
    gestureLayer.style.display = on ? 'block' : 'none';
  }

  /******** PREVIEW PINCH-ZOOM (mobile) + trackpad pinch (desktop) ********/
  let pzScale = 1;
  let pzTx = 0, pzTy = 0;

  const PZ_MIN = 1;   // min zoom
  const PZ_MAX = 5;   // max zoom

  const pointers = new Map();
  let pinchStartDist = 0;
  let pinchStartScale = 1;
  let pinchStartTx = 0, pinchStartTy = 0;
  let pinchWorldX = 0, pinchWorldY = 0;

  let panLastX = 0, panLastY = 0;

  function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

  function clampPan(){
    if (!previewViewport) return;
    const vw = previewViewport.clientWidth;
    const vh = previewViewport.clientHeight;

    const scaledW = vw * pzScale;
    const scaledH = vh * pzScale;

    if (scaledW <= vw) pzTx = (vw - scaledW) / 2;
    else pzTx = clamp(pzTx, vw - scaledW, 0);

    if (scaledH <= vh) pzTy = (vh - scaledH) / 2;
    else pzTy = clamp(pzTy, vh - scaledH, 0);
  }

  function applyPZ(){
    pzScale = clamp(pzScale, PZ_MIN, PZ_MAX);
    clampPan();
    if (previewZoomEl) previewZoomEl.style.transform = `translate(${pzTx}px, ${pzTy}px) scale(${pzScale})`;
  }

  function resetPZ(){
    pzScale = 1;
    pzTx = 0; pzTy = 0;
    applyPZ();
  }

  // Attach listeners once
  if (gestureLayer){
    gestureLayer.addEventListener('pointerdown', (e)=>{
      gestureLayer.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      if (pointers.size === 1){
        panLastX = e.clientX;
        panLastY = e.clientY;
      }

      if (pointers.size === 2){
        const [a,b] = [...pointers.values()];
        pinchStartDist = Math.hypot(a.x-b.x, a.y-b.y);
        pinchStartScale = pzScale;
        pinchStartTx = pzTx; pinchStartTy = pzTy;

        const rect = previewViewport.getBoundingClientRect();
        const cx = ((a.x + b.x) / 2) - rect.left;
        const cy = ((a.y + b.y) / 2) - rect.top;

        pinchWorldX = (cx - pinchStartTx) / pinchStartScale;
        pinchWorldY = (cy - pinchStartTy) / pinchStartScale;
      }
    });

    gestureLayer.addEventListener('pointermove', (e)=>{
      if (!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      const rect = previewViewport.getBoundingClientRect();

      if (pointers.size === 2){
        const [a,b] = [...pointers.values()];
        const dist = Math.hypot(a.x-b.x, a.y-b.y);
        if (pinchStartDist > 0){
          const cx = ((a.x + b.x) / 2) - rect.left;
          const cy = ((a.y + b.y) / 2) - rect.top;

          pzScale = pinchStartScale * (dist / pinchStartDist);

          pzTx = cx - pinchWorldX * pzScale;
          pzTy = cy - pinchWorldY * pzScale;

          applyPZ();
        }
        return;
      }

      // pan only if zoomed in
      if (pointers.size === 1 && pzScale > 1){
        const dx = e.clientX - panLastX;
        const dy = e.clientY - panLastY;
        panLastX = e.clientX;
        panLastY = e.clientY;

        pzTx += dx;
        pzTy += dy;
        applyPZ();
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if (pointers.size < 2) pinchStartDist = 0;
    }
    gestureLayer.addEventListener('pointerup', endPointer);
    gestureLayer.addEventListener('pointercancel', endPointer);
    gestureLayer.addEventListener('pointerleave', endPointer);

    // Trackpad pinch (Chrome/Edge): Ctrl + wheel
    gestureLayer.addEventListener('wheel', (e)=>{
      if (!e.ctrlKey) return;
      e.preventDefault(); // stop page zoom
      const rect = previewViewport.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;

      const wx = (cx - pzTx) / pzScale;
      const wy = (cy - pzTy) / pzScale;

      const factor = Math.exp(-e.deltaY * 0.002);
      pzScale *= factor;

      pzTx = cx - wx * pzScale;
      pzTy = cy - wy * pzScale;

      applyPZ();
    }, { passive:false });

    // Double tap/click to reset
    let lastTap = 0;
    gestureLayer.addEventListener('click', ()=>{
      const now = Date.now();
      if (now - lastTap < 280) resetPZ();
      lastTap = now;
    });
  }

  function showPreview(){
    resetPZ();
    previewBackdrop.style.display = 'block';
  }
  function hidePreview(){
    resetPZ();
    previewBackdrop.style.display = 'none';
    setGestureEnabled(true); // default back on

    try{ if(previewFrame.dataset.blobUrl){ URL.revokeObjectURL(previewFrame.dataset.blobUrl); previewFrame.dataset.blobUrl=''; } }catch{}
    try{ if(previewVideo.dataset.blobUrl){ URL.revokeObjectURL(previewVideo.dataset.blobUrl); previewVideo.dataset.blobUrl=''; } }catch{}
    previewFrame.src = 'about:blank';
    previewVideo.pause(); previewVideo.removeAttribute('src'); previewVideo.style.display='none';
    previewFrame.style.display='block';
  }
  previewBackdrop.addEventListener('click', (e)=>{ if(e.target === previewBackdrop) hidePreview(); });
  previewCloseBtn.addEventListener('click', hidePreview);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && previewBackdrop.style.display==='block') hidePreview(); });

  function isPdf(mime){ return (mime||'').toLowerCase().includes('pdf') || /\.pdf$/i.test(mime||''); }
  function isImage(mime,name){ return (mime||'').startsWith('image/') || /\.(png|jpe?g|gif|bmp|webp|svg)$/i.test(name||''); }
  function isVideo(mime,name){ return (mime||'').startsWith('video/') || /\.(mp4|mov|mkv|webm|avi)$/i.test(name||''); }

  async function openInlinePreview(f,isAdminMode){
    try{
      previewTitleEl.textContent = f.name || 'Preview';
      previewDownload.href = isAdminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : publicDownloadUrl(f.id);
      const previewUrl = `https://drive.google.com/file/d/${f.id}/preview`;
      const showWm = new URLSearchParams(location.search).get('wm')==='1';
      wmEl.style.display = showWm ? 'flex' : 'none';

      // Default: enable gestures for iframe/pdf/image
      setGestureEnabled(true);
      resetPZ();

      if (isVideo(f.mimeType, f.name)){
        // For video: disable gesture overlay so controls work
        setGestureEnabled(false);
        try{
          if(isAdminMode){
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewVideo.dataset.blobUrl = url;
            previewVideo.src = url;
          } else {
            previewVideo.src = publicDownloadUrl(f.id);
          }
          previewFrame.style.display='none';
          previewVideo.style.display='block';
          showPreview(); 
          return;
        }catch(e){ console.warn('Video inline failed, fallback to Drive preview'); }
      }

      if (isPdf(f.mimeType) || isImage(f.mimeType, f.name)){
        if(isAdminMode){
          try{
            const blob = await fetchPrivateBlob(f.id);
            const url = URL.createObjectURL(blob);
            previewFrame.dataset.blobUrl = url;
            previewFrame.src = url; 
            previewVideo.style.display='none';
            previewFrame.style.display='block';
            showPreview(); 
            return;
          }catch(e){ console.warn('Blob preview failed, fallback to Drive preview'); }
        }
        previewFrame.src = previewUrl; 
        previewVideo.style.display='none';
        previewFrame.style.display='block';
        showPreview(); 
        return;
      }

      window.open(f.webViewLink || `https://drive.google.com/file/d/${f.id}/view`, '_blank');
    }catch(e){ alert('Preview failed: '+(e.message||String(e))); }
  }

  /* ===== Sheets helpers (GViz → CSV fallbacks) ===== */
  function parseCsvTable(text){
    const rows = []; let row = [], inQuotes = false, field = '';
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (inQuotes){
        if (ch === '"' && next === '"'){ field += '"'; i++; }
        else if (ch === '"'){ inQuotes = false; }
        else { field += ch; }
      } else {
        if (ch === '"'){ inQuotes = true; }
        else if (ch === ','){ row.push(field); field=''; }
        else if (ch === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
        else if (ch === '\r'){ }
        else { field += ch; }
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    const headers = (rows.shift() || []).map(h => String(h||'').trim());
    return { headers, rows };
  }

  function parseDateSmart(v){
    if (v == null) return NaN;
    if (v instanceof Date) { const t=v.getTime(); return isNaN(t)?NaN:t; }
    if (typeof v === 'string' && /^Date\(\d{4},\d{1,2},\d{1,2}(,\d{1,2},\d{1,2}(,\d{1,2})?)?\)$/.test(v)){
      const nums=v.slice(5,-1).split(',').map(n=>parseInt(n,10));
      const [Y,M,D,h=0,m=0,s=0]=nums; const dt=new Date(Y, M, D, h, m, s); return dt.getTime();
    }
    if (typeof v === 'number' && isFinite(v)){ const ms=(v-25569)*86400*1000; return isNaN(ms)?NaN:ms; }
    const t=String(v).trim(); if(!t) return NaN;
    if(/^\d+(\.\d+)?$/.test(t)){ const n=Number(t); if(isFinite(n)){ const ms=(n-25569)*86400*1000; return isNaN(ms)?NaN:ms; } }
    let d=Date.parse(t); if(!Number.isNaN(d)) return d;
    let m=t.match(/^(\d{1,2})[\/.\-\s](\d{1,2})[\/.\-\s](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ let dd=+m[1], mm=+m[2], yy=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); if(yy<100) yy+=(yy>=70?1900:2000); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    m=t.match(/^(\d{4})[\/.\-\s](\d{1,2})[\/.\-\s](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ const yy=+m[1], mm=+m[2], dd=+m[3]; let hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); const dt=new Date(yy,mm-1,dd,hh,mi,ss); return isNaN(dt.getTime())?NaN:dt.getTime(); }
    return NaN;
  }
  function formatDateCell(v){
    const ms = parseDateSmart(v); if (isNaN(ms)) return String(v ?? '');
    const d = new Date(ms);
    const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear();
    const hh=d.getHours(); const mi=d.getMinutes(); const ss=d.getSeconds();
    const base=`${dd}.${mm}.${yyyy}`; return (hh+mi+ss)!==0 ? `${base} ${String(hh).padStart(2,'0')}:${String(mi).padStart(2,'0')}` : base;
  }

  async function fetchSheetTable(sheetId, sheetName, gid){
    if (sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('GViz JSON HTTP ' + res.status);
        let text = await res.text();
        text = text.replace(/^\)\]\}'\s*/, '').replace(/^\uFEFF/, '');
        const start = text.indexOf('{'), end = text.lastIndexOf('}');
        if (start === -1 || end === -1 || end <= start) throw new Error('Invalid GViz JSON payload');
        const data = JSON.parse(text.substring(start, end + 1));

        const cols=(data.table.cols||[]);
        const headers = cols.map(c => (c && (c.label || c.id)) || '');
        const types = cols.map(c => (c && c.type) || 'string').map(t => t==='date'||t==='datetime' ? 'date' : (t==='number' ? 'number' : 'text'));
        const rows = (data.table.rows||[]).map(r => (r.c||[]).map(c => {
          if(!c) return '';
          if (c.f != null && c.f !== '') return c.f;
          if (typeof c.v === 'string' && /^Date\(/.test(c.v)) return c.v;
          return (c.v ?? '');
        }));

        const looksLikeLetters = headers.length && headers.every(h => !h || /^[A-Z]+$/.test(String(h)));
        const allEmpty = headers.every(h => !h || String(h).trim()==='');
        let hdrs=headers, rws=rows, tys=types;
        if ((allEmpty || looksLikeLetters) && rows.length){ hdrs = rows[0].map(v => String(v||'').trim()); rws = rows.slice(1); }
        return { headers: hdrs, rows: rws, types: tys };
      } catch (e) {
        try {
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
          const rCsv = await fetch(csvUrl);
          if (!rCsv.ok) throw new Error('GViz CSV HTTP ' + rCsv.status);
          return parseCsvTable(await rCsv.text());
        } catch (e2) {
          if (gid) {
            const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
            const rCsv2 = await fetch(urlCsv);
            if (!rCsv2.ok) throw new Error('CSV export HTTP ' + rCsv2.status);
            return parseCsvTable(await rCsv2.text());
          }
          throw e2;
        }
      }
    }
    if (gid) {
      const urlCsv = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${gid}`;
      const rCsv = await fetch(urlCsv);
      if (!rCsv.ok) throw new Error('CSV export HTTP ' + rCsv.status);
      return parseCsvTable(await rCsv.text());
    }
    throw new Error('No sheetName or gid configured.');
  }

  /* ===== Work History table renderer ===== */
  function renderWorksTable(container, table, sheetId){
    container.innerHTML = '';

    const bar = document.createElement('div'); bar.className='toolbar';
    const search = document.createElement('input'); search.type='search'; search.placeholder='Search…';
    const adminBtns = document.createElement('div'); adminBtns.style.display='flex'; adminBtns.style.gap='8px'; adminBtns.style.marginLeft='auto';
    const dlBtn = document.createElement('button'); dlBtn.className='btn ghost badge'; dlBtn.textContent='Download CSV';
    const openGs = document.createElement('button'); openGs.className='btn ghost badge'; openGs.textContent='Open in Google Sheets (Admin)';
    adminBtns.append(dlBtn, openGs);
    adminBtns.style.display = (isAdmin() && isAdminSignedIn()) ? 'flex' : 'none';
    bar.append(search, adminBtns);
    container.appendChild(bar);

    const topScroll = document.createElement('div');
    topScroll.className = 'scroll-x-top';
    const topInner = document.createElement('div'); topInner.style.height = '1px';
    topScroll.appendChild(topInner); container.appendChild(topScroll);

    const wrap = document.createElement('div'); wrap.className='table-wrap';
    const tableEl = document.createElement('table'); tableEl.className='data';
    wrap.appendChild(tableEl); container.appendChild(wrap);

    const thead = document.createElement('thead'); const trh = document.createElement('tr');

    const wideIdx = new Set(); let assetCol = -1;
    table.headers.forEach((h,i)=>{ if(/job\s*description/i.test(h)) wideIdx.add(i); if(/action\s*taken/i.test(h)) wideIdx.add(i); if (/(^|\b)asset(\b|$)/i.test(h||'')) { assetCol = i; wideIdx.add(i); } });

    table.headers.forEach((h, idx) => {
      const th = document.createElement('th');
      th.innerHTML = `<span class="hint">${escapeHtml(h||`Col ${idx+1}`)}</span><span class="sort">⇅</span>`;
      if (wideIdx.has(idx)) th.classList.add('wide');
      if (idx === assetCol) th.classList.add('asset');
      th.addEventListener('click', () => sortBy(idx));
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tableEl.appendChild(thead);

    const tbody = document.createElement('tbody');
    tableEl.appendChild(tbody);

    let currentRows = table.rows.slice();

    const inferredTypes = (table.types && table.types.length===table.headers.length)
      ? table.types.slice()
      : table.headers.map((_, col) => {
          let isDate=true, isNum=true;
          for (let i=0;i<Math.min(currentRows.length, 50);i++){
            const v = currentRows[i][col];
            if (v==null || v==='') continue;
            const n = Number(v);
            if (!isFinite(n)) isNum=false;
            const d = parseDateSmart(v);
            if (isNaN(d)) isDate=false;
            if (!isDate && !isNum) break;
          }
          return isDate ? 'date' : (isNum ? 'number' : 'text');
        });

    function pickBestDateColumn(){
      const byName = table.headers.findIndex(h =>
        h && /^(completed\s*on|completed|completion\s*date|date\s*completed|date\/time|date|datum)$/i.test(String(h).trim())
      );
      if (byName !== -1) return byName;
      let bestCol = -1, bestCount = 0;
      for (let c=0; c<table.headers.length; c++){
        let cnt = 0;
        for (let i=0; i<Math.min(currentRows.length, 200); i++){
          const v = currentRows[i]?.[c];
          if (v==null || v==='') continue;
          const d = parseDateSmart(v);
          if (!isNaN(d)) cnt++;
        }
        if (cnt > bestCount){ bestCount = cnt; bestCol = c; }
      }
      return bestCount > 0 ? bestCol : -1;
    }

    let sortCol = -1, sortDir = 1;

    function cmp(a,b,col){
      const t = inferredTypes[col];
      const va = a[col], vb = b[col];
      if (t==='date'){
        const na = parseDateSmart(va);
        const nb = parseDateSmart(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      } else if (t==='number'){
        const na = Number(va); const nb = Number(vb);
        if (isNaN(na) && isNaN(nb)) return 0;
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      } else {
        const sa = String(va||'').toLowerCase();
        const sb = String(vb||'').toLowerCase();
        if (sa<sb) return -1;
        if (sa>sb) return 1;
        return 0;
      }
    }

    function updateSortIndicators(){
      const ths = thead.querySelectorAll('th .sort');
      ths.forEach((el, i)=>{
        el.textContent = (i===sortCol) ? (sortDir===1 ? '↑' : '↓') : '⇅';
        el.style.opacity = (i===sortCol) ? '1' : '.7';
      });
    }

    function displayValue(v, i){
      if (inferredTypes[i]==='date') return formatDateCell(v);
      if (inferredTypes[i]==='number') return String(v);
      return String(v ?? '');
    }

    const topInnerWidthSync = ()=> topInner.style.width = tableEl.scrollWidth + 'px';
    const syncFromTop   = ()=> wrap.scrollLeft = topScroll.scrollLeft;
    const syncFromBottom= ()=> topScroll.scrollLeft = wrap.scrollLeft;
    topScroll.addEventListener('scroll', syncFromTop, {passive:true});
    wrap.addEventListener('scroll', syncFromBottom, {passive:true});
    window.addEventListener('resize', ()=>requestAnimationFrame(topInnerWidthSync));

    function renderBody(){
      const q = (search.value||'').toLowerCase();
      tbody.innerHTML = '';
      currentRows.forEach(r => {
        if(q){
          const hit = r.some(v => String(v||'').toLowerCase().includes(q));
          if(!hit) return;
        }
        const tr = document.createElement('tr');
        r.forEach((v, i)=>{
          const td = document.createElement('td');
          const val = displayValue(v, i);
          if (inferredTypes[i]==='number') td.classList.add('cell-mono');
          if (i===assetCol) td.classList.add('asset');
          if (wideIdx.has(i)) td.classList.add('wide');
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      requestAnimationFrame(topInnerWidthSync);
    }

    function sortBy(colIdx){
      if(sortCol === colIdx){ sortDir *= -1; } else { sortCol = colIdx; sortDir = 1; }
      currentRows.sort((a,b)=> sortDir * cmp(a,b,colIdx) );
      updateSortIndicators();
      renderBody();
    }

    let completedCol = table.headers.findIndex(h =>
      h && /^(completed\s*on|completed|completion\s*date|date\s*completed)$/i.test(String(h).trim())
    );
    if (completedCol === -1) completedCol = pickBestDateColumn();
    if (completedCol !== -1){
      sortCol = completedCol;
      sortDir = 1;
      currentRows.sort((a,b)=> sortDir * cmp(a,b,completedCol) );
    }

    updateSortIndicators();
    renderBody();

    search.addEventListener('input', renderBody);

    dlBtn.onclick = ()=>{
      const esc =(s)=>('"'+String(s??'').replace(/"/g,'""')+'"');
      const lines = [ table.headers.map(esc).join(','), ...currentRows.map(row=>row.map(esc).join(',')) ].join('\r\n');
      const blob = new Blob([lines], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='work_history.csv'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    };
    openGs.onclick = async ()=>{
      try{
        await ensureAuth(); // admin only
        if (sheetId) window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/edit`, '_blank');
        else alert('Sheet ID not found');
      }catch(e){ alert('Admin sign-in failed: ' + (e.message || String(e))); }
    };

    setInterval(()=>{ adminBtns.style.display = (isAdmin() && isAdminSignedIn()) ? 'flex' : 'none'; }, 800);
  }

  async function drawWorksSheetView(bakery, machine, container){
    const entry = WORKS_SHEETS?.[bakery]?.[machine];
    if(!entry || !entry.sheetId){
      container.innerHTML = '<div class="small">No Google Sheet configured for this machine. Showing Drive listing instead.</div>';
      return null;
    }
    try{
      container.innerHTML = '<div class="small">Loading Work History…</div>';
      const table = await fetchSheetTable(entry.sheetId, entry.sheetName||'Sheet1', entry.gid);
      renderWorksTable(container, table, entry.sheetId);
      return true;
    }catch(e){
      container.innerHTML = `<div class="small">Failed to load Work History: ${escapeHtml(e.message||String(e))}</div>`;
      return true;
    }
  }

  /* ===== Views ===== */
  function folderIdFor(b,m,cat){ return FOLDERS?.[b]?.[m]?.[cat] || null; }

  function drawHome(){
    crumbsSet([{label:'Home'}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const wrap=document.createElement('div'); wrap.className='stack';

    ['Bakery 1','Bakery 2','Bakery 3','Other'].forEach(b=>{
      if (isOperator() && b==='Other') return; // operator ne vidi Other
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}`;
      a.innerHTML=`<h2>${b}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawBakery(b){
    if (isOperator() && b==='Other'){ go({}); return; }
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const machines = MACHINES[b]||[];
    const wrap=document.createElement('div'); wrap.className='stack';
    machines.forEach(m=>{
      const a=document.createElement('a');
      a.className='tile';
      a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}`;
      a.innerHTML=`<h2>${m}</h2><p>Open</p>`;
      wrap.appendChild(a);
    });
    view.appendChild(wrap);
  }

  function drawMachine(b,m){
    if (isOperator() && b==='Other'){ go({}); return; }
    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}}]);
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m}`; card.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid';

    const isOther = (b==='Other');

    if (isOther){
      ['documentation','procedures'].forEach(k=>{
        const meta=CATS[k];
        const a=document.createElement('a');
        a.className=`tile square ${meta.color}`;
        a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
        a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`;
        grid.appendChild(a);
      });
    } else {
      Object.entries(CATS).forEach(([k,meta])=>{
        if (isOperator() && (k==='works' || k==='electrical')) return; // operator ne vidi ova dva
        const a=document.createElement('a');
        a.className=`tile square ${meta.color}`;
        a.href=`?bakery=${encodeURIComponent(b)}&machine=${encodeURIComponent(m)}&cat=${encodeURIComponent(k)}`;
        a.innerHTML=`<h2>${meta.title}</h2><p>${meta.desc}</p>`;
        grid.appendChild(a);
      });
    }

    card.appendChild(grid);
    view.appendChild(card);
  }

  function drawCategory(b,m,catKey){
    const cat=CATS[catKey]; if(!cat){ go({bakery:b,machine:m}); return; }
    if (isOperator() && (catKey==='works' || catKey==='electrical')) { go({bakery:b,machine:m}); return; }
    if (b==='Other' && (catKey==='works' || catKey==='electrical')) { go({bakery:b,machine:m}); return; }

    crumbsSet([{label:'Home',to:{}},{label:b,to:{bakery:b}},{label:m,to:{bakery:b,machine:m}},{label:cat.title,to:{bakery:b,machine:m,cat:catKey}}]);

    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`${b} › ${m} › ${cat.title}`; card.appendChild(h);

    const fid = folderIdFor(b,m,catKey);
    const hint = document.createElement('div'); hint.className='small'; card.appendChild(hint);
    function refreshHint(){
      if(!fid){ hint.style.display = ''; hint.innerHTML = '⚠️ Set Drive folder ID in <code>FOLDERS</code>.'; }
      else if (isAdminSignedIn()) { hint.style.display = ''; hint.innerHTML = `Folder ID: <code>${escapeHtml(fid)}</code>`; }
      else { hint.style.display = 'none'; hint.innerHTML = ''; }
    }
    refreshHint();

    const bar=document.createElement('div'); bar.className='toolbar';
    const search=document.createElement('input'); search.type='search'; search.placeholder='Search files';
    const refresh=document.createElement('button'); refresh.className='btn ghost'; refresh.textContent='Refresh';

    const adminBtn=document.createElement('button'); adminBtn.className='btn ghost'; adminBtn.textContent='Admin: Sign in';
    const openFolderBtn=document.createElement('button'); openFolderBtn.className='btn'; openFolderBtn.textContent='Open Drive folder (Admin)'; openFolderBtn.style.display='none';
    openFolderBtn.onclick=()=>{ if(fid) window.open(`https://drive.google.com/drive/folders/${fid}`, '_blank'); };

    if (isAdmin()){ bar.append(adminBtn, openFolderBtn); }
    bar.append(search, refresh); card.appendChild(bar);

    const list=document.createElement('div'); list.className='list'; card.appendChild(list);
    view.appendChild(card);

    const allowSet = getOpAllowSet();
    const isDocOrProc = (catKey==='documentation' || catKey==='procedures');

    async function publicListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const params=new URLSearchParams({
          q:`'${fid}' in parents and trashed=false`,
          fields:'files(id,name,modifiedTime,mimeType,webViewLink)',
          orderBy:'modifiedTime desc', pageSize:'100', key:API_KEY,
          supportsAllDrives:'true', includeItemsFromAllDrives:'true'
        });
        const res=await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
        if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
        let items=(await res.json()).files||[];

        const s=(search.value||'').toLowerCase();
        if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));

        if (isOperator()){
          if (isDocOrProc){
            items = items.filter(f => allowSet.has(f.id));
            if (!items.length){ list.innerHTML = '<div class="small">No files allowed for operator yet.</div>'; return; }
          } else {
            list.innerHTML = '<div class="small">Not permitted.</div>'; return;
          }
        }

        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        items.sort((a, b) => a.name.localeCompare(b.name));
        renderFileRows(items, false);
      }catch(e){ list.innerHTML=`<div class="small">Public list error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    async function privateListFiles(){
      list.innerHTML='<div class="small">Loading…</div>';
      try{
        if(!fid){ list.innerHTML='<div class="small">Set Drive folder ID.</div>'; return; }
        const q=`'${fid}' in parents and trashed=false`;
        const res=await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink)', orderBy:'modifiedTime desc', pageSize:100, supportsAllDrives:true, includeItemsFromAllDrives:true });
        let items=res.result.files||[];
        const s=(search.value||'').toLowerCase(); if(s) items=items.filter(f=>(f.name||'').toLowerCase().includes(s));
        if(!items.length){ list.innerHTML='<div class="small">No files yet.</div>'; return; }
        items.sort((a,b) => a.name.localeCompare(b.name));
        renderFileRows(items, true);
      }catch(e){ list.innerHTML=`<div class='small'>Error: ${escapeHtml(e.message||String(e))}</div>`; }
    }

    function renderFileRows(items, adminMode){
      list.innerHTML='';
      items.forEach(f=>{
        const row=document.createElement('div'); row.className='item';

        const title=document.createElement('a'); title.className='title'; title.href='#';
        title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, adminMode); };
        const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
        title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;

        const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

        if (adminMode && isAdmin() && isDocOrProc){
          const lbl=document.createElement('label'); lbl.className='small'; lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked = getOpAllowSet().has(f.id);
          cb.onchange=()=> setOpAllow(f.id, cb.checked);
          lbl.append(cb, document.createTextNode('Allow operator'));
          right.appendChild(lbl);
        }

        const dl=document.createElement('a'); dl.className='icon-btn';
        dl.href = adminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : publicDownloadUrl(f.id);
        dl.target='_blank'; dl.rel='noopener';
        dl.title='Download';
        dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        right.appendChild(dl);

        if (adminMode && isAdmin()){
          const del=document.createElement('button'); del.className='icon-btn'; del.title='Delete';
          del.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M10 7v12m4-12v12M9 7l1-2h4l1 2M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          del.onclick=async()=>{ if(!confirm('Delete file?')) return;
            try{ await gapi.client.drive.files.delete({fileId:f.id}); await privateListFiles(); }
            catch(e){ alert('Delete failed: '+(e.result?.error?.message||e.message)); } };
          right.appendChild(del);
        }

        row.append(title, right);
        list.appendChild(row);
      });
    }

    // INIT
    publicListFiles();
    refresh.onclick = publicListFiles;
    search.oninput = publicListFiles;

    if (isAdmin()){
      adminBtn.onclick = async () => {
        try{
          await ensureAuth();
          refreshHint(); openFolderBtn.style.display=''; adminBtn.style.display='none';
          refresh.onclick = privateListFiles; search.oninput = privateListFiles; await privateListFiles();
          const signOut = document.createElement('button'); signOut.className='btn ghost'; signOut.textContent='Admin: Sign out';
          signOut.onclick = ()=>{ accessToken=null; alert('Signed out. Refresh to return to public mode.'); };
          bar.append(signOut);
        }catch(e){ alert('Sign-in failed: ' + (e.message || String(e))); }
      };
    }

    // Ako je kategorija Work History, pokušaj nacrtati tablicu iz Sheeta iznad liste
    if (catKey==='works'){
      if (isOperator()){ go({bakery:b,machine:m}); return; } // zaštita
      const sheetWrap = document.createElement('div');
      sheetWrap.className='card';
      sheetWrap.style.marginTop='12px';
      sheetWrap.innerHTML = '<div class="small">Loading Work History…</div>';
      view.insertBefore(sheetWrap, card);
      drawWorksSheetView(b,m,sheetWrap).then(loaded=>{
        if (loaded!==null){
          card.style.display = 'none';
        } else {
          sheetWrap.innerHTML = '<div class="small">No Sheet mapping found — showing Drive listing below.</div>';
        }
      });
    }
  }

  /* ===== Global Search ===== */
  function buildFolderIndex(){
    const out=[];
    for(const bakery of Object.keys(FOLDERS||{})){
      const machinesObj = FOLDERS[bakery] || {};
      for(const machine of Object.keys(machinesObj)){
        const cats = machinesObj[machine] || {};
        for(const catKey of Object.keys(cats)){
          const folderId = cats[catKey]; if(folderId){ out.push({ bakery, machine, cat:catKey, folderId }); }
        }
      }
    }
    return out;
  }
  const FOLDER_INDEX = buildFolderIndex();
  function escapeQueryForDrive(name){ return (name||'').replace(/'/g, "\\'"); }

  async function searchFolderPublic(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const params = new URLSearchParams({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:'50', key:API_KEY, supportsAllDrives:'true', includeItemsFromAllDrives:'true' });
    const res = await fetch('https://www.googleapis.com/drive/v3/files?'+params.toString());
    if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error(j.error?.message||('HTTP '+res.status)); }
    const data = await res.json(); return data.files || [];
  }
  async function searchFolderPrivate(folderId, query){
    const q = `'${folderId}' in parents and trashed=false and name contains '${escapeQueryForDrive(query)}'`;
    const res = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime,mimeType,webViewLink,parents)', orderBy:'modifiedTime desc', pageSize:50, supportsAllDrives:true, includeItemsFromAllDrives:true });
    return res.result.files || [];
  }

  function renderSearchResultsHeader(query){
    const view=document.getElementById('view'); view.innerHTML='';
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent=`Search results for “${query}”`; card.appendChild(h);
    const small=document.createElement('div'); small.className='small';
    small.textContent = isAdminSignedIn() ? 'Searching all mapped Drive folders (admin mode)…' : 'Searching public files in all mapped Drive folders…';
    card.appendChild(small);
    const list=document.createElement('div'); list.className='list'; list.id='globalResults'; card.appendChild(list);
    view.appendChild(card);
  }

  function appendSearchItem(container, meta, f, adminMode){
    const row=document.createElement('div'); row.className='item';
    const title=document.createElement('a'); title.className='title'; title.href='#'; title.onclick=(e)=>{ e.preventDefault(); openInlinePreview(f, adminMode); };
    const when=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
    const path = `${meta.bakery} › ${meta.machine} › ${CATS[meta.cat]?.title||meta.cat}`;
    title.innerHTML=`<div><strong>${escapeHtml(f.name)}</strong><div class="meta">${escapeHtml(path)} • ${escapeHtml(f.mimeType||'')} • ${escapeHtml(when)}</div></div>`;
    const dl=document.createElement('a'); dl.className='icon-btn';
    dl.href = adminMode ? `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media` : `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;
    dl.target='_blank'; dl.rel='noopener';
    dl.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    row.append(title, dl); container.appendChild(row);
  }

  async function drawSearch(query){
    crumbsSet([{label:'Home',to:{}},{label:`Search: ${query}`,to:{q:query}}]);
    renderSearchResultsHeader(query);
    const list = document.getElementById('globalResults');
    const concurrency = 6; let idx = 0, resultsCount = 0;

    const allowSet = getOpAllowSet();
    async function worker(){
      while(idx < FOLDER_INDEX.length){
        const i = idx++; const meta = FOLDER_INDEX[i];
        if (isOperator() && !(meta.cat==='documentation' || meta.cat==='procedures')) continue;
        try{
          let files = isAdminSignedIn() ? await searchFolderPrivate(meta.folderId, query) : await searchFolderPublic(meta.folderId, query);
          if (isOperator()) files = files.filter(f => allowSet.has(f.id));
          files.forEach(f => { appendSearchItem(list, meta, f, isAdminSignedIn()); resultsCount++; });
        }catch(e){ /* ignore */ }
      }
    }
    await Promise.all(Array.from({length: Math.min(concurrency, FOLDER_INDEX.length)}, worker));
    if(resultsCount === 0){ list.innerHTML = '<div class="small">No results.</div>'; }
  }

  /* ===== Router & Startup ===== */
  function draw(){
    refreshHeaderAuth();
    const p=params(); const b=p.get('bakery'); const m=p.get('machine'); const c=p.get('cat'); const q=p.get('q');

    if(q){ drawSearch(q); return; }
    if(!b){ drawHome(); return; }
    if(b && !m){ drawBakery(b); return; }
    if(b && m && !c){ drawMachine(b,m); return; }
    if(b && m && c){ drawCategory(b,m,c); return; }
  }

  window.addEventListener('load', ()=>{
    const stack = document.getElementById('homeStack');
    if (stack){
      stack.innerHTML = '';
      ['Bakery 1','Bakery 2','Bakery 3','Other'].forEach(B=>{
        if (isOperator() && B==='Other') return;
        const a=document.createElement('a');
        a.className='tile';
        a.href='?bakery=' + encodeURIComponent(B);
        a.innerHTML = `<h2>${B}</h2><p>Open</p>`;
        stack.appendChild(a);
      });
    }
    draw();
  });

  /* ===== Global search form ===== */
  const gsForm = document.getElementById('globalSearchForm');
  const gsInput = document.getElementById('globalSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  if(gsForm){
    gsForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const q = (gsInput.value||'').trim();
      if(q){ go({ q }); clearBtn.style.display=''; } else { go({}); clearBtn.style.display='none'; }
    });
  }
  if(clearBtn){ clearBtn.addEventListener('click', ()=>{ gsInput.value=''; go({}); clearBtn.style.display='none'; }); }

  /* ===== Multi-role PIN gate ===== */
  const lock = document.getElementById('lockscreen');
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  const pinMsg = document.getElementById('pinMsg');

  function doUnlock(role){
    sessionStorage.setItem('unlocked','1');
    sessionStorage.setItem('role', role);
    lock.style.display = 'none';
    pinMsg.style.display = 'none';
    pinInput.value='';
    refreshHeaderAuth();
    draw();
  }

  function checkPin(){
    const val=(pinInput.value||'').trim();
    const role = ROLE_PINS[val];
    if (role){
      doUnlock(role);
    } else {
      pinMsg.style.display = 'block';
      lock.animate([
        { transform:'translateX(0px)' },
        { transform:'translateX(-6px)' },
        { transform:'translateX(6px)' },
        { transform:'translateX(-4px)' },
        { transform:'translateX(4px)' },
        { transform:'translateX(0px)' }
      ], { duration: 250 });
      setTimeout(()=>pinMsg.style.display='none', 1800);
    }
  }
  pinBtn.addEventListener('click', checkPin);
  pinInput.addEventListener('keypress', e=>{ if(e.key === 'Enter') checkPin(); });

  if(sessionStorage.getItem('unlocked') === '1'){
    doUnlock(sessionStorage.getItem('role')||'operator');
  }
  </script>
</body>
</html>

</body>
</html>
